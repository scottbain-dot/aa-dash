<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strength Portal | Athlete Academy</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Clean light background */
        .bg-animated {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #f5f0f1;
            z-index: -2;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Particles hidden on light bg */
        .particles {
            display: none;
        }

        .particle {
            display: none;
        }

        @keyframes float {
            0%, 100% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) rotate(720deg); opacity: 0; }
        }

        /* Main container */
        .main-container {
            min-height: 100vh;
            padding: 20px;
            position: relative;
        }

        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            text-align: center;
            padding: 40px 20px;
            background: linear-gradient(135deg, #6a3a36, #874B46, #a06b66);
        }

        .welcome-logo {
            font-size: 80px;
            margin-bottom: 20px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .welcome-title {
            font-size: clamp(2.5rem, 6vw, 4rem);
            font-weight: 800;
            background: linear-gradient(135deg, #D4AF37, #FFD700, #D4AF37);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 10px;
        }

        .welcome-subtitle {
            font-size: 1.2rem;
            color: rgba(255,255,255,0.85);
            margin-bottom: 40px;
        }

        .privacy-notice {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            padding: 15px 25px;
            margin-bottom: 30px;
            max-width: 500px;
        }

        .privacy-notice p {
            color: rgba(255,255,255,0.9);
            font-size: 0.9rem;
            line-height: 1.5;
        }

        /* Loading States */
        .loading-container {
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin-top: 30px;
        }

        .loading-container.active {
            display: flex;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(255,255,255,0.1);
            border-top-color: #D4AF37;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: #444;
            font-size: 0.95rem;
        }

        .loading-subtext {
            color: #555;
            font-size: 0.85rem;
        }

        /* Portal (hidden until signed in) */
        .portal {
            display: none;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .portal.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            font-size: 2.5rem;
        }

        .header-title {
            font-size: 2rem;
            font-weight: 800;
            color: #1a1a1a;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(135, 75, 70, 0.1);
            padding: 8px 15px;
            border-radius: 50px;
        }

        .user-name {
            color: #231F20;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .logout-btn {
            background: none;
            border: none;
            color: #444;
            cursor: pointer;
            font-size: 1rem;
            padding: 4px 8px;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: rgba(135, 75, 70, 0.1);
            color: #874B46;
        }

        .back-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: #874B46;
            color: #fff;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            border: none;
            box-shadow: 0 4px 12px rgba(135, 75, 70, 0.3);
        }

        .back-btn:hover {
            background: #6a3a36;
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(135, 75, 70, 0.4);
        }

        /* White Card Base */
        .glass-card {
            background: #ffffff;
            border: 1px solid #e0e0e0;
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        /* Section Title */
        .section-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 8px;
        }

        .section-subtitle {
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 25px;
        }

        /* Progress Overview - Compact */
        .progress-grid {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            margin-bottom: 15px;
        }

        @media (max-width: 900px) {
            .progress-grid {
                grid-template-columns: repeat(6, 1fr);
            }
        }

        @media (max-width: 500px) {
            .progress-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .progress-card {
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .progress-card:hover {
            border-color: #874B46;
            transform: translateY(-3px);
            box-shadow: 0 6px 18px rgba(135,75,70,0.15);
        }

        .progress-card.active {
            border-color: #874B46;
            border-width: 2px;
            box-shadow: 0 4px 15px rgba(135,75,70,0.2);
        }

        .progress-card.testing {
            background: linear-gradient(135deg, #874B46, #6a3a36);
            border-color: #874B46;
        }

        .progress-card.testing .progress-pattern,
        .progress-card.testing .progress-level,
        .progress-card.testing .progress-label {
            color: #fff;
        }

        .progress-card.testing .progress-label {
            color: #D4AF37;
            font-weight: 600;
        }

        .progress-pattern {
            font-size: 0.7rem;
            font-weight: 700;
            color: #874B46;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .progress-level {
            font-size: 1.8rem;
            font-weight: 800;
            color: #1a1a1a;
        }

        .progress-label {
            font-size: 0.65rem;
            color: #666;
            margin-top: 2px;
            font-weight: 500;
        }

        /* Demo Section */
        .demo-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 30px;
        }

        @media (max-width: 800px) {
            .demo-section {
                grid-template-columns: 1fr;
            }
        }

        .demo-card {
            background: #fff;
            border: 2px solid #e0e0e0;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.06);
        }

        .demo-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Level Selector */
        .level-selector {
            display: flex;
            align-items: center;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .level-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #f5f0f1;
            border: none;
            color: #231F20;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .level-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .level-display {
            text-align: center;
            min-width: 150px;
        }

        .level-number {
            font-size: 0.8rem;
            color: #555;
            margin-bottom: 5px;
        }

        .level-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #231F20;
        }

        /* Video Placeholder */
        .video-placeholder {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            aspect-ratio: 16/9;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #555;
            margin-bottom: 15px;
        }

        .video-placeholder span {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        /* Tips List */
        .tips-list {
            list-style: none;
        }

        .tips-list li {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: #444;
            font-size: 0.9rem;
        }

        .tips-list li:last-child {
            border-bottom: none;
        }

        .tip-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        /* Warning Box */
        .warning-box {
            background: rgba(245, 158, 11, 0.1);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 12px;
            padding: 15px 20px;
            margin-top: 20px;
        }

        .warning-box h4 {
            color: #fbbf24;
            font-size: 0.9rem;
            margin-bottom: 8px;
        }

        .warning-box p {
            color: #444;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        /* Criteria Section */
        .criteria-section {
            margin-top: 25px;
        }

        .criteria-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .criteria-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #231F20;
        }

        .criteria-status {
            font-size: 0.8rem;
            color: #22c55e;
        }

        /* Checklist */
        .checklist {
            background: #f5f0f1;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .checklist-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #231F20;
            margin-bottom: 15px;
            text-align: center;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            color: #444;
            font-size: 0.9rem;
        }

        .checklist-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #874B46;
        }

        /* Submit Button */
        .submit-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #874B46, #6a3a36);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            text-align: center;
            text-decoration: none;
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(135, 75, 70, 0.4);
        }

        .submit-btn-note {
            text-align: center;
            color: #555;
            font-size: 0.8rem;
            margin-top: 10px;
        }

        /* Strength Testing Section */
        .strength-section {
            margin-top: 30px;
            margin-bottom: 30px;
        }

        .strength-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .strength-pattern-card {
            background: #f5f0f1;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(0,0,0,0.06);
        }

        .strength-pattern-card.locked {
            opacity: 0.6;
        }

        .strength-pattern-card.ready {
            border-color: rgba(135, 75, 70, 0.3);
            background: rgba(135, 75, 70, 0.05);
        }

        .strength-pattern-card.tested {
            border-color: rgba(34, 197, 94, 0.3);
            background: rgba(34, 197, 94, 0.05);
        }

        .strength-pattern-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .strength-pattern-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: #231F20;
        }

        .strength-pattern-status {
            font-size: 0.8rem;
            padding: 4px 10px;
            border-radius: 20px;
            font-weight: 500;
        }

        .strength-pattern-status.locked {
            background: rgba(107, 114, 128, 0.3);
            color: #9ca3af;
        }

        .strength-pattern-status.ready {
            background: rgba(135, 75, 70, 0.2);
            color: #D4AF37;
        }

        .strength-pattern-status.tested {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .strength-exercise-name {
            font-size: 0.95rem;
            color: #444;
            margin-bottom: 15px;
        }

        .testing-protocol {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .testing-protocol h4 {
            font-size: 0.85rem;
            color: #D4AF37;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .testing-protocol ol {
            margin: 0;
            padding-left: 20px;
            color: #444;
            font-size: 0.9rem;
            line-height: 1.7;
        }

        .load-tiers {
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .load-tiers h4 {
            font-size: 0.85rem;
            color: #fbbf24;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .load-tiers-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(50px, 1fr));
            gap: 8px;
        }

        @media (max-width: 500px) {
            .load-tiers-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .load-tier {
            text-align: center;
            padding: 8px 5px;
            background: #f5f0f1;
            border-radius: 8px;
        }

        .load-tier-number {
            font-size: 0.7rem;
            color: #555;
            margin-bottom: 3px;
        }

        .load-tier-weight {
            font-size: 0.9rem;
            font-weight: 600;
            color: #231F20;
        }

        .load-tier-weight-f {
            font-size: 0.75rem;
            color: #555;
            margin-top: 2px;
        }

        .safety-warning {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 10px;
            padding: 12px 15px;
        }

        .safety-warning-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .safety-warning-text {
            font-size: 0.9rem;
            color: #fca5a5;
            line-height: 1.5;
        }

        .tested-result {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: rgba(34, 197, 94, 0.1);
            border-radius: 10px;
        }

        .tested-result-value {
            font-size: 2rem;
            font-weight: 700;
            color: #22c55e;
        }

        .tested-result-label {
            font-size: 0.85rem;
            color: #444;
        }

        .tested-result-info {
            font-size: 0.85rem;
            color: #555;
            margin-top: 10px;
        }

        .locked-message {
            color: #555;
            font-size: 0.9rem;
        }

        .locked-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(239, 68, 68, 0.2);
            color: #fca5a5;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .unlocked-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(34, 197, 94, 0.2);
            color: #86efac;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* ============================================ */
        /* WORKOUT SECTION - IMPROVED */
        /* ============================================ */
        .workout-section {
            margin-top: 0;
            padding-top: 0;
        }

        .workout-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
        }

        .workout-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .workout-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #231F20;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .session-badge {
            background: linear-gradient(135deg, #874B46, #6a3a36);
            color: #fff;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .workout-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Loading State for Workout */
        .workout-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .workout-loading .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0,0,0,0.1);
            border-top-color: #874B46;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        .workout-loading-text {
            color: #444;
            font-size: 1rem;
        }

        .workout-loading-subtext {
            color: rgba(255,255,255,0.4);
            font-size: 0.85rem;
            margin-top: 5px;
        }

        /* Workout Content */
        .workout-content {
            display: none;
        }

        .workout-content.loaded {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* Session Info Bar */
        .session-info-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
            padding: 20px;
            background: rgba(135, 75, 70, 0.1);
            border: 1px solid rgba(135, 75, 70, 0.2);
            border-radius: 12px;
            margin-bottom: 25px;
        }

        @media (max-width: 600px) {
            .session-info-bar {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .session-info-item {
            text-align: center;
        }

        .session-info-label {
            font-size: 0.7rem;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .session-info-value {
            font-size: 1.1rem;
            font-weight: 600;
            color: #231F20;
            margin-top: 4px;
        }

        /* Exercise Categories */
        .exercise-category {
            margin-bottom: 25px;
        }

        .category-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #444;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .exercise-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 18px;
            background: #f5f0f1;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s ease;
        }

        .exercise-item:hover {
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.1);
        }

        .exercise-info {
            flex: 1;
        }

        .exercise-name {
            font-size: 1rem;
            font-weight: 600;
            color: #231F20;
            margin-bottom: 4px;
        }

        .exercise-details {
            font-size: 0.85rem;
            color: #555;
        }

        .exercise-weight {
            background: rgba(135, 75, 70, 0.2);
            color: #D4AF37;
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
        }

        /* Complete Session Button - MAIN FIX */
        .complete-session-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 14px 28px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #231F20;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 200px;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .complete-session-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(34, 197, 94, 0.4);
        }

        .complete-session-btn:active {
            transform: translateY(0);
        }

        .complete-session-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .complete-session-btn .btn-icon {
            font-size: 1.1rem;
        }

        /* View History Button */
        .view-history-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 20px;
            background: #f5f0f1;
            color: #231F20;
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-history-btn:hover {
            background: rgba(255,255,255,0.15);
            border-color: rgba(255,255,255,0.3);
        }

        /* Test Connection Button */
        .test-connection-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 14px 20px;
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .test-connection-btn:hover {
            background: rgba(34, 197, 94, 0.25);
        }

        /* Notes Section */
        .notes-section {
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .notes-label {
            display: block;
            font-size: 0.85rem;
            color: #444;
            margin-bottom: 10px;
        }

        .notes-input {
            width: 100%;
            padding: 15px;
            background: #f5f0f1;
            border: 1px solid rgba(0,0,0,0.08);
            border-radius: 12px;
            color: #231F20;
            font-size: 0.95rem;
            font-family: inherit;
            resize: vertical;
            min-height: 80px;
            transition: border-color 0.2s ease;
        }

        .notes-input::placeholder {
            color: rgba(255,255,255,0.3);
        }

        .notes-input:focus {
            outline: none;
            border-color: rgba(135, 75, 70, 0.5);
        }

        /* History Modal */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(30, 41, 59, 0.98), rgba(15, 23, 42, 0.98));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 30px;
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #231F20;
        }

        .modal-close {
            background: #f5f0f1;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            color: #231F20;
            font-size: 1.3rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .history-item {
            background: #f5f0f1;
            border-radius: 12px;
            padding: 18px;
            margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.05);
        }

        .history-date {
            font-size: 0.8rem;
            color: #555;
            margin-bottom: 8px;
        }

        .history-session {
            font-size: 1rem;
            font-weight: 600;
            color: #231F20;
            margin-bottom: 5px;
        }

        .history-notes {
            font-size: 0.85rem;
            color: #444;
            font-style: italic;
        }

        .no-history {
            text-align: center;
            padding: 40px;
            color: #555;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 25px;
            border-radius: 12px;
            color: #231F20;
            font-weight: 500;
            z-index: 2000;
            animation: slideIn 0.3s ease;
            display: none;
        }

        .toast.success {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .toast.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .toast.active {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ============================================ */
        /* WORKOUT TRACKING STYLES */
        /* ============================================ */
        
        /* Stats Counter Bar */
        .stats-counter {
            display: flex;
            gap: 20px;
            padding: 15px 20px;
            background: rgba(135, 75, 70, 0.1);
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid rgba(135, 75, 70, 0.2);
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #231F20;
            font-weight: 600;
        }

        .stat-icon {
            font-size: 1.2rem;
        }

        .stat-value {
            color: #D4AF37;
        }

        /* Session Timer */
        .session-timer {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 20px;
            background: rgba(34, 197, 94, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .timer-icon {
            font-size: 1.3rem;
        }

        .timer-value {
            font-family: 'Courier New', monospace;
            font-size: 1.3rem;
            font-weight: 700;
            color: #22c55e;
        }

        .timer-label {
            font-size: 0.75rem;
            color: #555;
            text-transform: uppercase;
        }

        /* Exercise Item with Checkbox */
        .exercise-item-tracked {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px 18px;
            background: #f5f0f1;
            border-radius: 12px;
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.05);
            transition: all 0.2s ease;
        }

        .exercise-item-tracked:hover {
            background: rgba(255,255,255,0.06);
        }

        .exercise-item-tracked.completed {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
        }

        .exercise-checkbox {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: 2px solid rgba(255,255,255,0.3);
            background: transparent;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .exercise-checkbox:hover {
            border-color: #22c55e;
        }

        .exercise-checkbox.checked {
            background: #22c55e;
            border-color: #22c55e;
        }

        .exercise-checkbox.checked::after {
            content: '✓';
            color: #231F20;
            font-weight: bold;
            font-size: 16px;
        }

        .exercise-main {
            flex: 1;
        }

        /* Weight Adjuster */
        .weight-adjuster {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(135, 75, 70, 0.15);
            padding: 6px 12px;
            border-radius: 10px;
        }

        .weight-btn {
            width: 36px;
            height: 36px;
            border-radius: 8px;
            border: 1px solid rgba(0,0,0,0.15);
            background: #fff;
            color: #231F20;
            font-size: 1.2rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }

        .weight-btn:hover {
            background: #f5f0f1;
            border-color: #874B46;
        }

        .weight-btn:active {
            transform: scale(0.95);
        }

        .weight-display {
            min-width: 80px;
            text-align: center;
            font-weight: 700;
            color: #874B46;
            font-size: 1.2rem;
        }

        /* Sloth Modal */
        /* Sloth Reminder Popup */
        .sloth-popup {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            z-index: 2000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
        }

        .sloth-popup.active {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
            pointer-events: auto;
        }

        .sloth-popup-content {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border: 1px solid rgba(245, 158, 11, 0.3);
            border-radius: 16px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            max-width: 400px;
        }

        .sloth-popup-icon {
            font-size: 2.5rem;
            animation: slothSway 2s ease-in-out infinite;
        }

        @keyframes slothSway {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        .sloth-popup-text {
            flex: 1;
            font-size: 0.9rem;
            color: rgba(255,255,255,0.9);
            line-height: 1.4;
        }

        .sloth-popup-text strong {
            color: #fbbf24;
        }

        .sloth-popup-close {
            padding: 8px 16px;
            background: rgba(245, 158, 11, 0.2);
            border: 1px solid rgba(245, 158, 11, 0.4);
            color: #fbbf24;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .sloth-popup-close:hover {
            background: rgba(245, 158, 11, 0.3);
        }

        /* RPE Modal */
        .rpe-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .rpe-modal.active {
            display: flex;
        }

        .rpe-content {
            text-align: center;
            max-width: 500px;
            width: 100%;
        }

        .rpe-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #231F20;
            margin-bottom: 8px;
        }

        .rpe-subtitle {
            font-size: 1rem;
            color: #444;
            margin-bottom: 30px;
        }

        .rpe-scale {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .rpe-option {
            background: #f5f0f1;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 15px 12px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 80px;
        }

        .rpe-option:hover {
            background: #f5f0f1;
            border-color: rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .rpe-option.selected {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
            transform: translateY(-2px);
        }

        .rpe-emoji {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .rpe-label {
            font-size: 1.1rem;
            font-weight: 700;
            color: #231F20;
            margin-bottom: 4px;
        }

        .rpe-desc {
            font-size: 0.75rem;
            color: #555;
        }

        .rpe-option.selected .rpe-desc {
            color: #22c55e;
        }

        .rpe-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
        }

        .rpe-skip-btn {
            padding: 14px 24px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: #444;
            border-radius: 10px;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rpe-skip-btn:hover {
            background: #f5f0f1;
            color: #444;
        }

        .rpe-confirm-btn {
            padding: 14px 28px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            color: #231F20;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            opacity: 0.5;
        }

        .rpe-confirm-btn:disabled {
            cursor: not-allowed;
        }

        .rpe-confirm-btn:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(34, 197, 94, 0.3);
        }

        /* Legacy sloth classes for weight increase modal */
        .sloth-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            backdrop-filter: blur(10px);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .sloth-modal.active {
            display: flex;
        }

        .sloth-content {
            text-align: center;
            max-width: 400px;
        }

        .sloth-emoji {
            font-size: 120px;
            margin-bottom: 20px;
            animation: slothSway 3s ease-in-out infinite;
        }

        @keyframes slothSway {
            0%, 100% { transform: rotate(-5deg); }
            50% { transform: rotate(5deg); }
        }

        .sloth-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #231F20;
            margin-bottom: 15px;
        }

        .sloth-message {
            font-size: 1.1rem;
            color: #444;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .sloth-timer {
            font-size: 2.5rem;
            font-weight: 800;
            color: #f59e0b;
            font-family: 'Courier New', monospace;
            margin-bottom: 20px;
        }

        .sloth-tip {
            font-size: 0.9rem;
            color: #555;
            padding: 15px;
            background: #f5f0f1;
            border-radius: 10px;
        }

        .sloth-dismiss-btn {
            margin-top: 20px;
            padding: 12px 24px;
            background: #f5f0f1;
            border: 1px solid rgba(255,255,255,0.2);
            color: #444;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .sloth-dismiss-btn:hover {
            background: rgba(255,255,255,0.15);
            color: rgba(255,255,255,0.9);
        }

        /* Start Session Button */
        .start-session-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 16px 32px;
            background: linear-gradient(135deg, #874B46, #6a3a36);
            color: #fff;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(135, 75, 70, 0.3);
        }

        .start-session-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(135, 75, 70, 0.4);
        }

        /* Session Not Started State */
        .session-not-started {
            text-align: center;
            padding: 40px 20px;
        }

        .session-not-started-icon {
            font-size: 60px;
            margin-bottom: 20px;
        }

        .session-not-started-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #231F20;
            margin-bottom: 10px;
        }

        .session-not-started-text {
            color: #444;
            margin-bottom: 25px;
        }

        /* Reps counter in exercise */
        .reps-info {
            font-size: 0.85rem;
            color: #444;
            margin-top: 4px;
        }

        /* ============================================ */
        /* VISUAL WORKOUT BLOCKS */
        /* ============================================ */
        
        .workout-block-container {
            position: relative;
        }

        .workout-block {
            background: #fff;
            border-radius: 16px;
            padding: 25px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        .block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .block-nav-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: #fff;
            border: 2px solid #ddd;
            border-radius: 12px;
            color: #1a1a1a;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }

        .block-nav-btn:hover:not(:disabled) {
            background: #874B46;
            color: #fff;
            border-color: #874B46;
            box-shadow: 0 4px 12px rgba(135, 75, 70, 0.3);
        }

        .block-nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .block-title-area {
            text-align: center;
        }

        .block-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: #1a1a1a;
            margin-bottom: 5px;
        }

        .block-subtitle {
            font-size: 0.9rem;
            color: #888;
            font-weight: 500;
        }

        .block-progress-dots {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-top: 10px;
        }

        .progress-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #ddd;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .progress-dot.active {
            background: #874B46;
            transform: scale(1.2);
        }

        .progress-dot.completed {
            background: #22c55e;
        }

        /* Video Container - Compact */
        .block-video-container {
            width: 100%;
            max-width: 400px;
            margin: 0 auto 20px;
            border-radius: 12px;
            overflow: hidden;
            background: rgba(0,0,0,0.3);
            aspect-ratio: 16/9;
        }

        .block-video-container iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .block-video-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .video-thumbnail-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
        }

        .video-play-btn {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background: rgba(0,0,0,0.7);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .block-video-container:hover .video-play-btn {
            background: rgba(255,0,0,0.9);
            transform: translate(-50%, -50%) scale(1.1);
        }

        .video-play-btn span {
            color: #231F20;
            font-size: 24px;
            margin-left: 4px;
        }

        /* No Video - Instructions */
        .block-instructions {
            background: rgba(135, 75, 70, 0.1);
            border: 1px solid rgba(135, 75, 70, 0.2);
            border-radius: 12px;
            padding: 20px;
            margin: 0 auto 25px;
            max-width: 600px;
        }

        .block-instructions h4 {
            color: #D4AF37;
            font-size: 1rem;
            margin-bottom: 12px;
        }

        .block-instructions ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .block-instructions li {
            color: #444;
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
            font-size: 0.95rem;
        }

        .block-instructions li::before {
            content: '•';
            position: absolute;
            left: 8px;
            color: #D4AF37;
        }

        /* Exercise Info in Block */
        .block-exercise-info {
            text-align: center;
            margin-bottom: 15px;
        }

        .block-exercise-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #231F20;
            margin-bottom: 5px;
        }

        .block-exercise-details {
            font-size: 0.95rem;
            color: #444;
        }

        .block-exercise-pattern {
            display: inline-block;
            background: rgba(135, 75, 70, 0.2);
            color: #D4AF37;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 8px;
        }

        /* Weight Control in Block */
        .block-weight-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin: 15px 0;
        }

        .block-weight-btn {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            border: none;
            background: #f5f0f1;
            color: #231F20;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .block-weight-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .block-weight-display {
            font-size: 1.8rem;
            font-weight: 700;
            color: #D4AF37;
            min-width: 100px;
            text-align: center;
        }

        .block-weight-label {
            font-size: 0.75rem;
            color: #555;
            text-align: center;
            margin-top: 3px;
        }

        /* Sets Grid */
        .sets-grid {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
            flex-wrap: wrap;
        }

        .set-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
        }

        .set-checkbox {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            border: 3px solid #ccc;
            background: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 20px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
        }

        .set-checkbox:hover {
            border-color: #22c55e;
            background: rgba(34, 197, 94, 0.1);
            transform: scale(1.05);
        }

        .set-checkbox.checked {
            background: #22c55e;
            border-color: #22c55e;
        }

        .set-checkbox.checked::after {
            content: '✓';
            color: #fff;
            font-weight: bold;
        }

        .set-label {
            font-size: 0.9rem;
            color: #333;
            font-weight: 500;
        }

        .set-reps {
            font-size: 0.8rem;
            color: #666;
        }

        /* Block Tip */
        .block-tip {
            text-align: center;
            padding: 15px;
            background: rgba(245, 158, 11, 0.1);
            border-radius: 10px;
            margin-top: 20px;
        }

        .block-tip-text {
            color: #fbbf24;
            font-size: 0.9rem;
        }

        /* Complete Block Button */
        .complete-block-btn {
            display: block;
            width: 100%;
            max-width: 300px;
            margin: 25px auto 0;
            padding: 15px 30px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #231F20;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .complete-block-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.3);
        }

        .complete-block-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Summary Block */
        .summary-block {
            text-align: center;
        }

        .summary-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .summary-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: #231F20;
            margin-bottom: 10px;
        }

        .summary-stats {
            display: flex;
            justify-content: center;
            gap: 40px;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .summary-stat {
            text-align: center;
        }

        .summary-stat-value {
            font-size: 2.5rem;
            font-weight: 800;
            color: #22c55e;
        }

        .summary-stat-label {
            font-size: 0.9rem;
            color: #555;
        }

        .summary-exercises {
            background: #f5f0f1;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
        }

        .summary-exercise-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            color: #444;
        }

        .summary-exercise-item:last-child {
            border-bottom: none;
        }

        .summary-exercise-item.completed {
            color: #22c55e;
        }

        .summary-exercise-item.completed::before {
            content: '✓ ';
        }
    </style>
</head>
<body>
    <!-- Animated Background -->
    <div class="bg-animated"></div>
    <div class="particles" id="particles"></div>

    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcomeScreen">
        <div class="welcome-logo">🏆</div>
        <h1 class="welcome-title">Athlete Academy</h1>
        <p class="welcome-subtitle">Master your technique, unlock your strength potential</p>
        
        <div class="privacy-notice">
            <p><strong>Privacy Notice:</strong> This system tracks your athletic development. 
            Only you and your teacher can see your data. Sign in with your school Google account.</p>
        </div>

        <!-- Google Sign-In -->
        <div id="g_id_onload"
             data-client_id="701639243214-ud6m1qtmc6ma0pq6v24tk39afbuhcblv.apps.googleusercontent.com"
             data-context="signin"
             data-ux_mode="popup"
             data-callback="handleCredentialResponse"
             data-auto_prompt="false">
        </div>
        <div class="g_id_signin"
             data-type="standard"
             data-shape="rectangular"
             data-theme="filled_blue"
             data-text="signin_with"
             data-size="large"
             data-logo_alignment="left">
        </div>

        <div class="loading-container" id="loadingContainer">
            <div class="spinner"></div>
            <p class="loading-text" id="loadingText">Loading your strength portal...</p>
            <p class="loading-subtext">Fetching data from Google Sheets...</p>
        </div>
    </div>

    <!-- Main Portal -->
    <div class="main-container">
        <div class="portal" id="portal">
            <!-- Header -->
            <header class="header">
                <div class="header-left">
                    <span class="header-logo">🏋️</span>
                    <h1 class="header-title">Strength Portal</h1>
                </div>
                <div class="header-right">
                    <div class="user-info">
                        <span class="user-name" id="userName">Athlete</span>
                        <button onclick="logout()" class="logout-btn" title="Sign out">↪</button>
                    </div>
                    <a href="index.html" class="back-btn">← Back to Dashboard</a>
                </div>
            </header>

            <!-- ============================================ -->
            <!-- UNIFIED WORKOUT SECTION -->
            <!-- ============================================ -->
            <section class="workout-section" id="workoutSection" style="margin-top: 0; padding-top: 0; border-top: none;">
                <div class="workout-card">
                    
                    <!-- Compact Progress Tiles -->
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                            <div style="font-size: 0.85rem; font-weight: 600; color: #888; text-transform: uppercase; letter-spacing: 0.5px;">📊 My Progress</div>
                        </div>
                        <div class="progress-grid" id="progressGrid" style="margin-bottom: 0; gap: 10px;">
                            <!-- Filled by JavaScript -->
                        </div>
                    </div>

                    <!-- Pattern Detail Panel (expandable - hidden by default) -->
                    <div id="patternDetailPanel" style="display: none; margin-bottom: 20px;">
                        <!-- Filled dynamically when a progress tile is tapped -->
                    </div>
                    <div class="workout-header">
                        <div class="workout-title">
                            🏋️ Your Personal Workout Plan
                            <span class="session-badge" id="sessionBadge">Loading...</span>
                        </div>
                        <div class="workout-actions">
                            <div class="session-timer" id="sessionTimer" style="display: none;">
                                <span class="timer-icon">⏱️</span>
                                <div>
                                    <div class="timer-value" id="timerDisplay">00:00</div>
                                    <div class="timer-label">Session Time</div>
                                </div>
                            </div>
                            <button class="complete-session-btn" id="completeSessionBtn" onclick="attemptCompleteSession()" style="display: none;">
                                <span class="btn-icon">✓</span>
                                <span class="btn-text">Complete Session</span>
                            </button>
                            <button class="view-history-btn" onclick="showWorkoutHistory()">
                                📊 View History
                            </button>
                        </div>
                    </div>

                    <!-- Stats Counter -->
                    <div class="stats-counter" id="statsCounter">
                        <div class="stat-item">
                            <span class="stat-icon">💪</span>
                            <span><span class="stat-value" id="totalSessions">0</span> Sessions</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-icon">🏋️</span>
                            <span><span class="stat-value" id="totalReps">0</span> reps logged</span>
                        </div>
                    </div>

                    <!-- Loading State -->
                    <div class="workout-loading" id="workoutLoading">
                        <div class="spinner"></div>
                        <div class="workout-loading-text">Loading your workout plan...</div>
                        <div class="workout-loading-subtext">Fetching personalized exercises and weights</div>
                    </div>

                    <!-- Session Not Started State -->
                    <div class="session-not-started" id="sessionNotStarted" style="display: none;">
                        <div class="session-not-started-icon">🎯</div>
                        <div class="session-not-started-title">Ready for Session <span id="nextSessionType">A</span>?</div>
                        <div class="session-not-started-text">Start your workout to begin tracking time and exercises.</div>
                        <button class="start-session-btn" onclick="startSession()">
                            <span>▶️</span> Start Session
                        </button>
                        
                        <!-- Session selector for previous sessions -->
                        <div id="sessionSelector" style="margin-top: 25px; padding-top: 20px; border-top: 1px solid #e5e0df;">
                            <div style="font-size: 0.85rem; color: #888; margin-bottom: 12px;">Or select a different session:</div>
                            <div id="sessionButtons" style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
                                <!-- Filled dynamically -->
                            </div>
                        </div>
                    </div>

                    <!-- Workout Block Container (hidden until session started) -->
                    <div class="workout-block-container" id="workoutBlockContainer" style="display: none;">
                        <div class="workout-block" id="currentBlock">
                            <!-- Dynamically filled based on current block -->
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal-overlay" id="historyModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">📊 Workout History</h3>
                <button class="modal-close" onclick="closeHistoryModal()">×</button>
            </div>
            <div id="historyList">
                <!-- Filled dynamically -->
            </div>
        </div>
    </div>

    <!-- Sloth Reminder Popup (simplified) -->
    <div class="sloth-popup" id="slothModal">
        <div class="sloth-popup-content">
            <div class="sloth-popup-icon">🦥</div>
            <div class="sloth-popup-text">
                <strong>Take your time!</strong><br>
                Rest 90-120s between sets for best results.
            </div>
            <button class="sloth-popup-close" onclick="dismissSlothModal()">Got it</button>
        </div>
    </div>

    <!-- Weight Increase Confirmation Modal -->
    <div class="sloth-modal" id="weightIncreaseModal">
        <div class="sloth-content" style="max-width: 400px;">
            <div class="sloth-emoji">💪</div>
            <div class="sloth-title">Increasing Weight</div>
            <div class="sloth-message" style="margin-bottom: 20px;">
                You're about to lift <strong>more than last time</strong><br>
                <span style="color: #555;"><span id="weightIncreaseFrom"></span>kg</span>
                <span style="color: #22c55e; margin: 0 10px;">→</span>
                <span style="color: #22c55e; font-weight: 700;"><span id="weightIncreaseTo"></span>kg</span>
            </div>
            
            <div style="text-align: left; margin-bottom: 25px;">
                <div style="color: #444; margin-bottom: 15px; font-weight: 600;">Can you:</div>
                
                <label style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; cursor: pointer;">
                    <input type="checkbox" class="weight-check" onchange="updateWeightConfirmBtn()" style="width: 20px; height: 20px; margin-top: 2px; accent-color: #22c55e;">
                    <span style="color: #333; font-size: 0.95rem;">Complete all reps - no half reps or skipping</span>
                </label>
                
                <label style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 12px; cursor: pointer;">
                    <input type="checkbox" class="weight-check" onchange="updateWeightConfirmBtn()" style="width: 20px; height: 20px; margin-top: 2px; accent-color: #22c55e;">
                    <span style="color: #333; font-size: 0.95rem;">Keep your form solid from first rep to last</span>
                </label>
                
                <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
                    <input type="checkbox" class="weight-check" onchange="updateWeightConfirmBtn()" style="width: 20px; height: 20px; margin-top: 2px; accent-color: #22c55e;">
                    <span style="color: #333; font-size: 0.95rem;">Finish feeling strong, not completely wiped out</span>
                </label>
            </div>
            
            <div style="display: flex; gap: 12px;">
                <button onclick="cancelWeightIncrease()" style="flex: 1; padding: 14px 20px; border: 1px solid rgba(255,255,255,0.2); background: transparent; color: #444; border-radius: 10px; font-size: 0.95rem; cursor: pointer;">
                    Stay at <span id="weightStayAt"></span>kg
                </button>
                <button id="confirmWeightBtn" onclick="confirmWeightIncrease()" disabled style="flex: 1; padding: 14px 20px; border: none; background: linear-gradient(135deg, #22c55e, #16a34a); color: #231F20; border-radius: 10px; font-size: 0.95rem; font-weight: 600; cursor: pointer; opacity: 0.5;">
                    I've got this
                </button>
            </div>
        </div>
    </div>

    <!-- RPE Modal -->
    <div class="rpe-modal" id="rpeModal">
        <div class="rpe-content">
            <div class="rpe-title">How did that feel?</div>
            <div class="rpe-subtitle">Rate your effort for this session</div>
            
            <div class="rpe-scale">
                <div class="rpe-option" data-rpe="1" onclick="selectRpe(1)">
                    <div class="rpe-emoji">😴</div>
                    <div class="rpe-label">1-2</div>
                    <div class="rpe-desc">Very Easy</div>
                </div>
                <div class="rpe-option" data-rpe="3" onclick="selectRpe(3)">
                    <div class="rpe-emoji">😊</div>
                    <div class="rpe-label">3-4</div>
                    <div class="rpe-desc">Easy</div>
                </div>
                <div class="rpe-option" data-rpe="5" onclick="selectRpe(5)">
                    <div class="rpe-emoji">😐</div>
                    <div class="rpe-label">5-6</div>
                    <div class="rpe-desc">Moderate</div>
                </div>
                <div class="rpe-option" data-rpe="7" onclick="selectRpe(7)">
                    <div class="rpe-emoji">😤</div>
                    <div class="rpe-label">7-8</div>
                    <div class="rpe-desc">Hard</div>
                </div>
                <div class="rpe-option" data-rpe="9" onclick="selectRpe(9)">
                    <div class="rpe-emoji">🥵</div>
                    <div class="rpe-label">9-10</div>
                    <div class="rpe-desc">Max Effort</div>
                </div>
            </div>
            
            <div class="rpe-buttons">
                <button class="rpe-skip-btn" onclick="skipRpe()">Skip</button>
                <button id="rpeConfirmBtn" class="rpe-confirm-btn" onclick="confirmRpeAndComplete()" disabled>
                    Complete Session
                </button>
            </div>
        </div>
    </div>

    <!-- Progression Prompt Modal -->
    <div class="sloth-modal" id="progressionModal" style="display: none;">
        <div class="sloth-content" style="max-width: 420px;">
            <div class="sloth-emoji">📈</div>
            <div class="sloth-title">Ready to Progress?</div>
            <div id="progressionMessage" class="sloth-message" style="margin-bottom: 15px;">
                <!-- Filled dynamically -->
            </div>
            
            <div style="background: rgba(34,197,94,0.1); border: 1px solid rgba(34,197,94,0.3); border-radius: 12px; padding: 15px; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px; font-size: 1.3rem;">
                    <span style="color: #555;" id="progressionFrom"></span>
                    <span style="color: #22c55e; font-size: 1.5rem;">→</span>
                    <span style="color: #22c55e; font-weight: 700;" id="progressionTo"></span>
                </div>
                <div style="color: #666; font-size: 0.85rem; margin-top: 8px; text-align: center;" id="progressionReason"></div>
            </div>
            
            <div style="text-align: left; margin-bottom: 20px;">
                <div style="color: #444; margin-bottom: 12px; font-weight: 600; font-size: 0.9rem;">Before you progress, confirm:</div>
                
                <label style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" class="progression-check" onchange="updateProgressionConfirmBtn()" style="width: 20px; height: 20px; margin-top: 2px; accent-color: #22c55e;">
                    <span style="color: #333; font-size: 0.9rem;">I can complete all reps with solid form at this weight</span>
                </label>
                
                <label style="display: flex; align-items: flex-start; gap: 12px; margin-bottom: 10px; cursor: pointer;">
                    <input type="checkbox" class="progression-check" onchange="updateProgressionConfirmBtn()" style="width: 20px; height: 20px; margin-top: 2px; accent-color: #22c55e;">
                    <span style="color: #333; font-size: 0.9rem;">I'll still have 1-2 reps left in the tank after each set</span>
                </label>
                
                <label style="display: flex; align-items: flex-start; gap: 12px; cursor: pointer;">
                    <input type="checkbox" class="progression-check" onchange="updateProgressionConfirmBtn()" style="width: 20px; height: 20px; margin-top: 2px; accent-color: #22c55e;">
                    <span style="color: #333; font-size: 0.9rem;">I'm feeling strong and ready to push today</span>
                </label>
            </div>
            
            <div style="display: flex; gap: 12px;">
                <button onclick="declineProgression()" style="flex: 1; padding: 14px 16px; border: 1px solid #ddd; background: #f5f5f5; color: #444; border-radius: 10px; font-size: 0.9rem; cursor: pointer;">
                    Stay at current
                </button>
                <button id="confirmProgressionBtn" onclick="acceptProgression()" disabled style="flex: 1; padding: 14px 16px; border: none; background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff; border-radius: 10px; font-size: 0.9rem; font-weight: 600; cursor: pointer; opacity: 0.5;">
                    Let's go! 💪
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwWqNLpNchDNUZJ5VOSseGsoAIuOGeaPjISq9O9NCQZSEwKI3IQm7dfPBnTff41uOR1/exec';
        
        // Cache settings
        const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
        let athleteDataCache = null;
        let cacheTimestamp = 0;

        // ============================================
        // AVAILABLE WEIGHTS (snap to real equipment)
        // ============================================
        const AVAILABLE_WEIGHTS = {
            dumbbell: [4, 6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26, 28, 30, 32, 34, 36, 38, 40],
            kettlebell: [4, 8, 12, 16, 20, 24, 28, 32],
            barbell: [] // Generated as 2.5kg increments from 20kg bar
        };
        // Generate barbell weights: 20kg bar + plates in 2.5kg increments up to 150kg
        for (let w = 20; w <= 150; w += 2.5) {
            AVAILABLE_WEIGHTS.barbell.push(w);
        }

        // Detect equipment type from exercise name and round to nearest available weight
        function roundToAvailableWeight(weight, exerciseName) {
            if (!weight || weight <= 0 || weight === 'bodyweight') return weight;
            
            const name = (exerciseName || '').toLowerCase();
            let availableWeights;
            let isDumbbell = false;
            
            if (name.includes('dumbbell') || name.includes('db ')) {
                availableWeights = AVAILABLE_WEIGHTS.dumbbell;
                isDumbbell = true;
            } else if (name.includes('kettlebell') || name.includes('kb ') || name.includes('goblet')) {
                availableWeights = AVAILABLE_WEIGHTS.kettlebell;
            } else if (name.includes('barbell') || name.includes('bb ') || name.includes('hex bar') || name.includes('back squat') || name.includes('front squat') || name.includes('bench press') || name.includes('deadlift')) {
                availableWeights = AVAILABLE_WEIGHTS.barbell;
            } else {
                // Default to 2.5kg rounding for unknown equipment
                return Math.round(weight / 2.5) * 2.5;
            }
            
            // For dumbbells: round the PER-HAND weight, then double for total
            // This ensures we get weights that actually exist (e.g., 8kg each hand = 16kg total)
            let weightToRound = isDumbbell ? weight / 2 : weight;
            
            // Find nearest available weight
            let closest = availableWeights[0];
            let minDiff = Math.abs(weightToRound - closest);
            
            for (const w of availableWeights) {
                const diff = Math.abs(weightToRound - w);
                if (diff < minDiff) {
                    minDiff = diff;
                    closest = w;
                }
            }
            
            // For dumbbells, return the total (per-hand × 2)
            return isDumbbell ? closest * 2 : closest;
        }

        // Current user
        let currentUser = null;
        let currentStrength = null;
        let currentSessionType = 'A';
        let currentSessionNumber = 1;

        // Workout session tracking
        let sessionStartTime = null;
        let sessionTimer = null;
        let exerciseData = []; // Tracks exercises with completion status and weights
        const MIN_SESSION_DURATION = 20 * 60 * 1000; // 20 minutes in ms (for final completion)
        const MIN_BLOCK_DURATION = 60 * 1000; // 60 seconds minimum per block
        const SLOTH_PAUSE_DURATION = 90 * 1000; // 90 second pause if too fast
        let blockStartTime = null; // Track when current block was started
        let slothPauseActive = false;
        let slothShown = false;

        // Session control - reads from Config sheet via API
        let maxAvailableSession = 1; // Will be fetched from config

        // Visual Block System
        let workoutBlocks = []; // Array of block objects
        let currentBlockIndex = 0;
        let currentSession = 1; // Which session they're on

        // Movement patterns data - DO NOT MODIFY exercise names, videos, or criteria without explicit approval

        // ============================================
        // SESSION PERSISTENCE (survives page refresh)
        // ============================================
        const SESSION_STORAGE_KEY = 'sp_active_session';
        
        function getStrengthHash() {
            // Create a simple hash of strength data to detect admin changes
            if (!currentStrength) return '';
            const keys = patterns.map(p => `${p.name}_Tech,${p.name}_Str`).flat();
            return keys.map(k => `${k}=${currentStrength[k] || 0}`).join('|');
        }
        
        function saveSessionToStorage() {
            if (!sessionStartTime) return;
            try {
                const state = {
                    sessionStartTime: sessionStartTime,
                    currentBlockIndex: currentBlockIndex,
                    currentSessionType: currentSessionType,
                    currentSessionNumber: currentSessionNumber,
                    slothShown: slothShown,
                    athleteId: currentUser?.athleteId,
                    strengthHash: getStrengthHash(),
                    // Save completion state + weight adjustments for every exercise in every block
                    blockStates: workoutBlocks.map(block => ({
                        type: block.type,
                        exercises: block.exercises ? block.exercises.map(ex => ({
                            completed: [...ex.completed],
                            weight: ex.weight
                        })) : null
                    })),
                    savedAt: Date.now()
                };
                localStorage.setItem(SESSION_STORAGE_KEY, JSON.stringify(state));
            } catch(e) {
                console.warn('Could not save session state:', e);
            }
        }
        
        function loadSessionFromStorage() {
            try {
                const raw = localStorage.getItem(SESSION_STORAGE_KEY);
                if (!raw) return null;
                const state = JSON.parse(raw);
                
                // Expire after 3 hours (session can't be that long)
                if (Date.now() - state.savedAt > 3 * 60 * 60 * 1000) {
                    clearSessionStorage();
                    return null;
                }
                return state;
            } catch(e) {
                clearSessionStorage();
                return null;
            }
        }
        
        function clearSessionStorage() {
            try { localStorage.removeItem(SESSION_STORAGE_KEY); } catch(e) {}
        }
        
        function restoreSessionState(saved) {
            // Restore timing and position
            sessionStartTime = saved.sessionStartTime;
            currentBlockIndex = saved.currentBlockIndex;
            slothShown = saved.slothShown || false;
            
            // Restore completion + weight states onto the already-built workoutBlocks
            if (saved.blockStates && saved.blockStates.length === workoutBlocks.length) {
                saved.blockStates.forEach((savedBlock, bIdx) => {
                    const block = workoutBlocks[bIdx];
                    if (savedBlock.exercises && block.exercises) {
                        savedBlock.exercises.forEach((savedEx, eIdx) => {
                            if (block.exercises[eIdx]) {
                                // Restore checkbox states
                                if (savedEx.completed) {
                                    block.exercises[eIdx].completed = savedEx.completed;
                                }
                                // Restore weight adjustments
                                if (savedEx.weight !== undefined && savedEx.weight !== null) {
                                    block.exercises[eIdx].weight = savedEx.weight;
                                }
                            }
                        });
                    }
                });
            }
            
            // Restore UI to active session state
            document.getElementById('sessionNotStarted').style.display = 'none';
            document.getElementById('workoutBlockContainer').style.display = 'block';
            document.getElementById('sessionTimer').style.display = 'flex';
            document.getElementById('completeSessionBtn').style.display = 'none';
            
            // Restart timer display
            updateTimer();
            sessionTimer = setInterval(updateTimer, 1000);
            
            // Render current block
            renderCurrentBlock();
            
            showToast('♻️ Session restored — keep going!', 'success');
        }

        // Movement patterns data
        const patterns = [
            { 
                key: 'Squat', 
                name: 'Squat',
                testLevel: 2,
                exercises: {
                    1: { name: 'Bodyweight Squat', video: 'https://www.youtube.com/embed/iiKn5FiVUjI' },
                    2: { name: 'Goblet Squat', video: 'https://www.youtube.com/embed/pEGfGwp6IEA' },
                    3: { name: 'Back Squat', video: 'https://www.youtube.com/embed/j-KDHkRMer0' },
                    4: { name: 'Front Squat', video: 'https://www.youtube.com/embed/ddJklKFk2yg' },
                    5: { name: 'Pistol / Squat Clean', video: 'https://www.youtube.com/embed/D934zSaVtU0' }
                },
                criteria: [
                    { text: 'Feet flat throughout', note: 'No heel rise at any point' },
                    { text: 'Knees track over toes', note: 'No valgus (inward) collapse' },
                    { text: 'Hip crease below top of knee', note: 'At the bottom of the squat' },
                    { text: 'Neutral spine maintained', note: 'No excessive rounding or arching' },
                    { text: 'Controlled descent', note: '2+ seconds down' },
                    { text: 'No excessive forward lean', note: 'Torso angle within 45°' }
                ],
                loadTiers: { M: [8, 16, 24, 32, 36], F: [6, 12, 18, 24, 28] }
            },
            { 
                key: 'Push', 
                name: 'Push',
                testLevel: 2,
                exercises: {
                    1: { name: 'Floor Push Up', video: 'https://www.youtube.com/embed/Ql8PKKsDE70' },
                    2: { name: 'Dumbbell Bench Press', video: 'https://www.youtube.com/embed/ZaDlbm8E8Tg' },
                    3: { name: 'Barbell Bench Press', video: 'https://www.youtube.com/embed/ejI1Nlsul9k' },
                    4: { name: 'Single Arm DB Press', video: 'https://www.youtube.com/embed/sM9eFPV7VVA' },
                    5: { name: 'Plyo Push Up', video: 'https://www.youtube.com/embed/q3cXdiyY7-Q' }
                },
                criteria: [
                    { text: 'Full range of motion', note: 'Chest to bar/floor, full lockout' },
                    { text: 'Elbows at 45° angle', note: 'Not flared out at 90°' },
                    { text: 'Shoulder blades retracted', note: 'Pinched together throughout' },
                    { text: 'Core engaged, no sagging', note: 'Body in straight line (push up)' },
                    { text: 'Controlled descent', note: 'No bouncing off chest' },
                    { text: 'Feet stable on ground', note: 'No leg drive unless intended' }
                ],
                loadTiers: { M: [8, 16, 24, 32, 40], F: [6, 12, 18, 24, 32] }
            },
            { 
                key: 'Pull', 
                name: 'Pull',
                testLevel: 2,
                testType: 'reps', // Rep-based test instead of 5RM
                exercises: {
                    1: { name: 'Banded Row', video: 'https://www.youtube.com/embed/j7ABJGauUEk' },
                    2: { name: 'Horizontal Pull / Inverted Row', video: 'https://www.youtube.com/embed/vZy_Eu_Z0WA' },
                    3: { name: 'Dumbbell Row', video: 'https://www.youtube.com/embed/aVH_cG4UISc' },
                    4: { name: 'Pull Up', video: 'https://www.youtube.com/embed/jgFel4wZl3I' },
                    5: { name: 'Weighted Pull Up / Clean Pull', video: 'https://www.youtube.com/embed/2m58VKBEQuo' }
                },
                criteria: [
                    { text: 'Full range of motion', note: 'Arm extended to fully contracted' },
                    { text: 'Shoulder blade retracts', note: 'Squeeze back at top' },
                    { text: 'No excessive body swing', note: 'Controlled movement' },
                    { text: 'Elbow drives back', note: 'Not just arm pulling' },
                    { text: 'Chest up, shoulders down', note: 'No shrugging' },
                    { text: 'Core engaged throughout', note: 'Stable torso' }
                ],
                loadTiers: { M: [5, 8, 12, 15, 20], F: [3, 5, 8, 12, 15] }
            },
            { 
                key: 'Hinge', 
                name: 'Hinge',
                testLevel: 2,
                exercises: {
                    1: { name: 'Bodyweight Hinge', video: 'https://www.youtube.com/embed/3Cb3Zvglx1U' },
                    2: { name: 'Kettlebell Deadlift', video: 'https://www.youtube.com/embed/PXJpKhdN9PM' },
                    3: { name: 'Hex Bar Deadlift', video: 'https://www.youtube.com/embed/FYx76NSijfU' },
                    4: { name: 'Barbell Deadlift', video: 'https://www.youtube.com/embed/TN3DHmd1Fe8' },
                    5: { name: 'Single Leg RDL / Power Clean', video: 'https://www.youtube.com/embed/pJewPISyHjw' }
                },
                criteria: [
                    { text: 'Spine neutral throughout', note: 'No rounding of lower back' },
                    { text: 'Hips hinge back first', note: 'Not a squat pattern' },
                    { text: 'Knees soft but not excessive bend', note: 'Roughly 15-20° knee flexion' },
                    { text: 'Weight in mid-foot/heels', note: 'Not on toes' },
                    { text: 'Shoulders over or slightly in front of bar', note: 'At start position' },
                    { text: 'Full hip extension at top', note: 'Squeeze glutes, stand tall' }
                ],
                loadTiers: { M: [8, 16, 20, 24, 28], F: [8, 16, 20, 24, 28] }
            },
            { 
                key: 'Lunge', 
                name: 'Lunge',
                testLevel: 2,
                exercises: {
                    1: { name: 'Bodyweight Lunge', video: 'https://www.youtube.com/embed/krxGoIpg9XQ' },
                    2: { name: 'Dumbbell Lunge', video: 'https://www.youtube.com/embed/9gglI77Kzq8' },
                    3: { name: 'Barbell Lunge', video: 'https://www.youtube.com/embed/Z6i2IQqTuU0' },
                    4: { name: 'Rear Foot Elevated Split Squat', video: 'https://www.youtube.com/embed/3fxmRoIE_fk' },
                    5: { name: 'Lateral Lunge / Split Jerk', video: 'https://www.youtube.com/embed/At9MCuYtvBU' }
                },
                criteria: [
                    { text: 'Front knee tracks over toes', note: 'No valgus collapse' },
                    { text: 'Back knee approaches floor', note: 'Full depth, controlled' },
                    { text: 'Torso upright', note: 'No excessive forward lean' },
                    { text: '90° angles at both knees', note: 'At bottom position' },
                    { text: 'Front heel stays down', note: 'Weight through whole foot' },
                    { text: 'Controlled throughout', note: 'No wobbling or loss of balance' }
                ],
                loadTiers: { M: [8, 16, 24, 32, 40], F: [6, 12, 18, 24, 32] }
            },
            { 
                key: 'Press', 
                name: 'Press',
                testLevel: 2,
                exercises: {
                    1: { name: 'Band Overhead Press', video: 'https://www.youtube.com/embed/1-VfJqjYquQ' },
                    2: { name: 'Dumbbell Press', video: 'https://www.youtube.com/embed/OM23fjJB3-0' },
                    3: { name: 'Barbell Press', video: 'https://www.youtube.com/embed/I7ND5OficOo' },
                    4: { name: 'Push Press', video: 'https://www.youtube.com/embed/MmjM11GJPAM' },
                    5: { name: 'Single Arm OH / Jerk', video: 'https://www.youtube.com/embed/FUwme_oBDsA' }
                },
                criteria: [
                    { text: 'Full lockout overhead', note: 'Arms fully extended' },
                    { text: 'Bar path straight', note: 'Head moves back, not bar forward' },
                    { text: 'Core braced throughout', note: 'No excessive back arch' },
                    { text: 'Elbows in front of bar', note: 'At start position' },
                    { text: 'Controlled descent', note: 'Back to shoulders with control' },
                    { text: 'Feet stay planted', note: 'No stepping (unless push press)' }
                ],
                loadTiers: { M: [6, 14, 24, 32, 36], F: [4, 10, 18, 24, 28] }
            }
        ];

        let selectedPattern = patterns[0];
        let selectedLevel = 1;
        
        // ============================================
        // PROGRESSION SYSTEM
        // ============================================
        // Tracks pending progression prompts to show after workout loads
        let pendingProgressionPrompts = [];
        
        // Progression rules per pattern type
        const PROGRESSION_RULES = {
            // Barbell compounds: +2.5kg after 1 successful session
            'Squat': { increment: 2.5, sessionsRequired: 1, type: 'weight' },
            'Hinge': { increment: 2.5, sessionsRequired: 1, type: 'weight' },
            'Push': { increment: 2.5, sessionsRequired: 1, type: 'weight' },
            // Dumbbell accessories: +2kg after 1 successful session
            'Lunge': { increment: 2, sessionsRequired: 1, type: 'weight' },
            // Press: +2kg after 2 successful sessions (harder to progress)
            'Press': { increment: 2, sessionsRequired: 2, type: 'weight' },
            // Pull: +1 rep after 1 successful session
            'Pull': { increment: 1, sessionsRequired: 1, type: 'reps' }
        };
        
        // Count consecutive successful sessions at a specific weight/rep for a pattern
        function countConsecutiveSuccessfulSessions(allHistory, patternName, sessionType, targetWeight) {
            // Filter to sessions of the same type (A or B) that include this pattern
            const relevantSessions = allHistory
                .filter(s => s.sessionType === sessionType)
                .sort((a, b) => new Date(b.date) - new Date(a.date)); // Most recent first
            
            let consecutiveCount = 0;
            
            for (const session of relevantSessions) {
                try {
                    let exercises = session.exercises;
                    if (typeof exercises === 'string') exercises = JSON.parse(exercises);
                    if (!Array.isArray(exercises)) continue;
                    
                    const patternEx = exercises.find(ex => ex.pattern === patternName);
                    if (!patternEx) continue;
                    
                    const sessionWeight = parseFloat(patternEx.weight) || 0;
                    const sessionSets = parseInt(patternEx.sets) || 0;
                    
                    // Check if they completed all sets at this weight
                    if (sessionWeight === targetWeight && sessionSets >= 3) {
                        consecutiveCount++;
                    } else {
                        // Chain broken - different weight or didn't complete sets
                        break;
                    }
                } catch (e) {
                    console.warn('Error parsing session for progression check:', e);
                    continue;
                }
            }
            
            return consecutiveCount;
        }
        
        // Check if student is eligible for progression and build prompt data
        function checkProgressionEligibility(patternName, exerciseName, lastData, allHistory, sessionType, isRepBased) {
            if (!lastData || !lastData.weight) return null;
            
            const rules = PROGRESSION_RULES[patternName];
            if (!rules) return null;
            
            const lastWeight = parseFloat(lastData.weight) || 0;
            const lastSets = parseInt(lastData.sets) || 0;
            
            // Must have completed 3+ sets last time
            if (lastSets < 3 || lastWeight <= 0) return null;
            
            // Count consecutive successful sessions at this weight
            const consecutiveSessions = countConsecutiveSuccessfulSessions(
                allHistory, patternName, sessionType, lastWeight
            );
            
            console.log(`📈 ${patternName} progression check: ${consecutiveSessions} consecutive sessions at ${lastWeight}kg (need ${rules.sessionsRequired})`);
            
            // Check if they've met the required sessions
            if (consecutiveSessions >= rules.sessionsRequired) {
                const newValue = isRepBased 
                    ? Math.round(lastWeight) + rules.increment  // For Pull, lastWeight is actually reps
                    : roundToAvailableWeight(lastWeight + rules.increment, exerciseName);
                
                return {
                    patternName,
                    exerciseName,
                    currentValue: isRepBased ? Math.round(lastWeight) : lastWeight,
                    newValue,
                    increment: rules.increment,
                    type: rules.type,
                    consecutiveSessions,
                    sessionsRequired: rules.sessionsRequired
                };
            }
            
            return null;
        }

        // ============================================
        // PARTICLES
        // ============================================
        function createParticles() {
            const container = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                container.appendChild(particle);
            }
        }
        createParticles();

        // ============================================
        // GOOGLE SIGN-IN
        // ============================================
        
        function handleCredentialResponse(response) {
            const payload = JSON.parse(atob(response.credential.split('.')[1]));
            
            currentUser = {
                email: payload.email,
                name: payload.name,
                picture: payload.picture,
                loginTime: Date.now()
            };

            // Save to localStorage for persistence across refresh and browser close
            localStorage.setItem('athleteUser', JSON.stringify(currentUser));

            console.log('Signed in as:', currentUser.email);
            
            document.getElementById('loadingContainer').classList.add('active');
            document.getElementById('loadingText').textContent = `Welcome, ${currentUser.name.split(' ')[0]}!`;
            
            loadPortal();
        }

        // Check for existing session on page load
        function checkExistingSession() {
            const savedUser = localStorage.getItem('athleteUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    
                    // Check if login is less than 7 days old
                    const loginAge = Date.now() - (currentUser.loginTime || 0);
                    const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 days
                    
                    if (loginAge > maxAge) {
                        // Session expired, clear and require new login
                        localStorage.removeItem('athleteUser');
                        currentUser = null;
                        return false;
                    }
                    
                    console.log('Restored session for:', currentUser.email);
                    document.getElementById('loadingContainer').classList.add('active');
                    document.getElementById('loadingText').textContent = `Welcome back, ${currentUser.name.split(' ')[0]}!`;
                    loadPortal();
                    return true;
                } catch (e) {
                    localStorage.removeItem('athleteUser');
                    return false;
                }
            }
            return false;
        }

        // Logout function
        function logout() {
            localStorage.removeItem('athleteUser');
            athleteDataCache = null;
            currentUser = null;
            location.reload();
        }

        // Run session check when page loads
        window.addEventListener('load', function() {
            // Check immediately for existing session
            if (!checkExistingSession()) {
                // No existing session, Google Sign-In button will show
                console.log('No existing session, showing login');
            }
        });

        // ============================================
        // DATA FETCHING
        // ============================================
        async function fetchAthleteData(email) {
            if (athleteDataCache && (Date.now() - cacheTimestamp) < CACHE_DURATION) {
                console.log('Using cached data');
                return athleteDataCache;
            }

            try {
                const url = `${APPS_SCRIPT_URL}?action=getAthleteData&email=${encodeURIComponent(email)}`;
                console.log('Fetching from:', url);
                
                const response = await fetch(url);
                const data = await response.json();
                
                console.log('Received data:', data);
                
                if (data.authenticated || data.success) {
                    athleteDataCache = data;
                    cacheTimestamp = Date.now();
                    return data;
                } else {
                    console.error('API error:', data.error);
                    return null;
                }
            } catch (error) {
                console.error('Fetch error:', error);
                return null;
            }
        }

        async function fetchLastSession(email) {
            try {
                const url = `${APPS_SCRIPT_URL}?action=getLastSession&email=${encodeURIComponent(email)}`;
                const response = await fetch(url);
                const data = await response.json();
                return data.success ? data.lastSession : null;
            } catch (error) {
                console.error('Error fetching last session:', error);
                return null;
            }
        }

        async function fetchLastSessionByType(email, sessionType) {
            try {
                const url = `${APPS_SCRIPT_URL}?action=getLastSessionByType&email=${encodeURIComponent(email)}&sessionType=${sessionType}`;
                const response = await fetch(url);
                const data = await response.json();
                return data.success ? data.lastSession : null;
            } catch (error) {
                console.error('Error fetching last session by type:', error);
                return null;
            }
        }

        async function fetchWorkoutHistory(email, limit = 10) {
            try {
                const url = `${APPS_SCRIPT_URL}?action=getWorkoutHistory&email=${encodeURIComponent(email)}&limit=${limit}`;
                console.log('📋 History fetch URL:', url);
                const response = await fetch(url);
                console.log('📋 History response status:', response.status);
                const text = await response.text();
                console.log('📋 History raw response:', text.substring(0, 500));
                
                let data;
                try {
                    data = JSON.parse(text);
                } catch(e) {
                    console.error('📋 History JSON parse error:', e, 'Raw text:', text.substring(0, 200));
                    return [];
                }
                
                console.log('📋 History parsed data:', data);
                
                // Handle different possible response structures
                if (data.success && data.history) return data.history;
                if (data.history) return data.history;
                if (Array.isArray(data)) return data;
                
                console.warn('📋 Unexpected history format:', Object.keys(data));
                return [];
            } catch (error) {
                console.error('📋 History fetch error:', error);
                return [];
            }
        }

        // ============================================
        // PORTAL RENDERING
        // ============================================
        async function loadPortal() {
            const data = await fetchAthleteData(currentUser.email);
            
            console.log('loadPortal - data received:', data);
            
            document.getElementById('welcomeScreen').style.display = 'none';
            document.getElementById('portal').classList.add('active');
            document.getElementById('userName').textContent = currentUser.name;

            // Store the numeric Athlete_ID for use in all API calls
            currentUser.athleteId = data?.athlete?.Athlete_ID || currentUser.email;
            console.log('loadPortal - athleteId:', currentUser.athleteId);

            // Strength is nested inside athlete object, also get gender from athlete
            const strength = data?.athlete?.strength || {};
            const gender = data?.athlete?.Gender || 'M';
            console.log('loadPortal - strength:', strength, 'gender:', gender);
            
            if (strength) {
                // Add gender to currentStrength for use in 3T level
                currentStrength = { ...strength, Gender: gender };
                renderProgressGrid(strength);
            } else {
                console.log('loadPortal - NO strength data found');
            }

            // Load workout plan
            loadWorkoutPlan();
        }

        function renderProgressGrid(strength) {
            console.log('renderProgressGrid called with:', strength);
            const container = document.getElementById('progressGrid');
            console.log('progressGrid container:', container);
            container.innerHTML = '';
            const gender = strength?.Gender || currentStrength?.Gender || 'M';

            patterns.forEach((pattern, index) => {
                const techKey = pattern.name + '_Tech';
                const strKey = pattern.name + '_Str';
                const techLevel = parseInt(strength?.[techKey]) || 0;
                const strengthTier = parseInt(strength?.[strKey]) || 0;
                
                const hasStrength = strengthTier > 0;
                const isReadyToTest = techLevel >= 2 && !hasStrength;
                const isRepBased = pattern.testType === 'reps';
                
                const card = document.createElement('div');
                card.className = 'progress-card';
                card.onclick = () => togglePatternDetail(index);
                
                if (isReadyToTest) {
                    // Ready to test - burgundy
                    card.style.cssText = 'background: linear-gradient(135deg, #874B46, #6a3a36); border-color: #874B46;';
                    card.innerHTML = `
                        <div class="progress-pattern" style="color: #D4AF37;">${pattern.name.toUpperCase()}</div>
                        <div class="progress-level" style="color: #fff; font-size: 1.4rem;">⚡</div>
                        <div class="progress-label" style="color: #D4AF37; font-weight: 600;">TEST</div>
                    `;
                } else if (hasStrength) {
                    // Tested - show tech level + tier/weight
                    const loadTiers = gender === 'F' ? pattern.loadTiers.F : pattern.loadTiers.M;
                    const tierWeight = loadTiers[strengthTier - 1] || 0;
                    const tierLabel = isRepBased ? `T${strengthTier} · ${tierWeight} reps` : `T${strengthTier} · ${tierWeight}kg`;
                    
                    card.innerHTML = `
                        <div class="progress-pattern">${pattern.name.toUpperCase()}</div>
                        <div class="progress-level" style="font-size: 1.6rem;">${techLevel} <span style="color: #22c55e; font-size: 0.8rem;">✓</span></div>
                        <div class="progress-label" style="color: #874B46; font-weight: 600; font-size: 0.65rem;">${tierLabel}</div>
                    `;
                } else {
                    // Normal tech level
                    card.innerHTML = `
                        <div class="progress-pattern">${pattern.name.toUpperCase()}</div>
                        <div class="progress-level">${techLevel}</div>
                        <div class="progress-label">Tech Lvl</div>
                    `;
                }
                container.appendChild(card);
            });
        }

        const PRACTICES_TO_FILM_GLOBAL = 3;

        function updateProgressTilesWithPractice(allHistory) {
            // Count practices per pattern - match specific next-level exercise name
            const practiceCounts = {};
            const nextExerciseNames = {};
            patterns.forEach(pattern => {
                practiceCounts[pattern.name] = 0;
                const techLevel = parseInt(currentStrength?.[pattern.name + '_Tech']) || 0;
                const nextLevel = techLevel + 1;
                const nextEx = pattern.exercises[nextLevel];
                nextExerciseNames[pattern.name] = nextEx ? nextEx.name : null;
            });
            
            if (allHistory && allHistory.length > 0) {
                allHistory.forEach(session => {
                    try {
                        let exercises = session.exercises;
                        if (typeof exercises === 'string') exercises = JSON.parse(exercises);
                        if (Array.isArray(exercises)) {
                            const practicedInSession = new Set();
                            exercises.forEach(ex => {
                                if (ex.pattern && nextExerciseNames[ex.pattern] && ex.name === nextExerciseNames[ex.pattern]) {
                                    practicedInSession.add(ex.pattern);
                                }
                            });
                            practicedInSession.forEach(p => practiceCounts[p]++);
                        }
                    } catch(e) {}
                });
            }
            
            // Practice counts from all sessions
            // No baseline inflation needed - count is accurate for next-level practices
            
            // Update each tile's subtitle with practice info
            const cards = document.querySelectorAll('.progress-card');
            cards.forEach((card, index) => {
                const pattern = patterns[index];
                const techLevel = parseInt(currentStrength?.[pattern.name + '_Tech']) || 0;
                const strTier = parseInt(currentStrength?.[pattern.name + '_Str']) || 0;
                const hasStrength = strTier > 0;
                const isReadyToTest = techLevel >= 2 && !hasStrength;
                
                // Practice info only shown in the workout technique block, not on tiles
            });
        }

        let expandedPatternIndex = -1;

        function togglePatternDetail(index) {
            const panel = document.getElementById('patternDetailPanel');
            
            // Toggle off if same tile tapped
            if (expandedPatternIndex === index) {
                panel.style.display = 'none';
                expandedPatternIndex = -1;
                document.querySelectorAll('.progress-card').forEach(c => c.classList.remove('active'));
                return;
            }
            
            expandedPatternIndex = index;
            document.querySelectorAll('.progress-card').forEach((c, i) => c.classList.toggle('active', i === index));
            
            const pattern = patterns[index];
            const techKey = pattern.name + '_Tech';
            const strKey = pattern.name + '_Str';
            const techLevel = parseInt(currentStrength?.[techKey]) || 0;
            const strengthTier = parseInt(currentStrength?.[strKey]) || 0;
            const hasStrength = strengthTier > 0;
            const gender = currentStrength?.Gender || 'M';
            const isReadyToTest = techLevel >= 2 && !hasStrength;
            
            // Determine display level - show CURRENT level (what they've achieved)
            let displayLevel;
            if (isReadyToTest) {
                displayLevel = 'TEST';
            } else if (techLevel >= 5) {
                displayLevel = 5;
            } else if (techLevel === 0) {
                // Haven't passed anything yet - show level 1 as what they're working on
                displayLevel = 1;
            } else {
                // Show current achieved level
                displayLevel = techLevel;
            }
            
            let html = `<div style="background: #fff; border: 2px solid #e0e0e0; border-radius: 16px; padding: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);">`;
            html += `<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">`;
            html += `<div style="font-size: 1.1rem; font-weight: 700; color: #1a1a1a;">${pattern.name} Pattern</div>`;
            html += `<button onclick="togglePatternDetail(${index})" style="background: #f5f0f1; border: none; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1rem; color: #666;">✕</button>`;
            html += `</div>`;
            
            if (displayLevel === 'TEST') {
                // Strength Test Info
                const loadTiers = gender === 'F' ? pattern.loadTiers.F : pattern.loadTiers.M;
                const isRepBased = pattern.testType === 'reps';
                const testExercise = pattern.exercises[2]; // Level 2 is the test exercise
                
                html += `<div style="background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff; padding: 12px; border-radius: 10px; text-align: center; margin-bottom: 15px; font-weight: 600;">⚡ Ready to Test!</div>`;
                
                // Show Level 2 exercise video
                if (testExercise && testExercise.video) {
                    const videoId = testExercise.video.split('/embed/')[1];
                    html += `<div style="font-size: 0.9rem; font-weight: 600; color: #231F20; margin-bottom: 8px;">${testExercise.name}</div>`;
                    html += `<div style="border-radius: 10px; overflow: hidden; margin-bottom: 15px; aspect-ratio: 16/9; max-width: 400px; background: #000;">`;
                    html += `<div id="detailVidWrapper-${index}" style="width: 100%; height: 100%; cursor: pointer; position: relative;" onclick="playVideo(this, '${videoId}')">`;
                    html += `<img src="https://img.youtube.com/vi/${videoId}/hqdefault.jpg" style="width: 100%; height: 100%; object-fit: cover;">`;
                    html += `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 56px; height: 56px; background: rgba(0,0,0,0.7); border-radius: 50%; display: flex; align-items: center; justify-content: center;"><span style="color: #fff; font-size: 22px; margin-left: 3px;">▶</span></div>`;
                    html += `</div>`;
                    html += `</div>`;
                }
                
                html += `<div style="background: rgba(239, 68, 68, 0.08); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 10px; padding: 10px 14px; margin-bottom: 12px; font-size: 0.85rem; color: #666;">⚠️ Supervision required — Request a slot from Mr. Bain</div>`;
                
                html += `<div style="margin-bottom: 12px;"><div style="font-weight: 600; color: #874B46; font-size: 0.85rem; margin-bottom: 8px;">📋 PROTOCOL</div>`;
                if (isRepBased) {
                    html += `<div style="font-size: 0.85rem; color: #444; line-height: 1.7;">1. Start with bodyweight<br>2. Perform as many clean reps as possible<br>3. Stop when technique breaks<br><em style="color: #888;">This is a max rep test</em></div>`;
                } else {
                    html += `<div style="font-size: 0.85rem; color: #444; line-height: 1.7;">1. Warm up with light sets<br>2. Start Tier 1 → 5 clean reps<br>3. Rest 2-3 min if successful<br>4. Move to next tier<br>5. Stop when technique breaks<br><em style="color: #888;">This is a technique test, not a max lift</em></div>`;
                }
                html += `</div>`;
                
                // Load tiers
                if (!isRepBased) {
                    html += `<div style="margin-bottom: 12px;"><div style="font-weight: 600; color: #D4AF37; font-size: 0.85rem; margin-bottom: 8px;">🏋️ LOAD TIERS (${gender})</div>`;
                    html += `<div style="display: flex; gap: 6px; flex-wrap: wrap;">`;
                    loadTiers.forEach((w, i) => {
                        html += `<div style="text-align: center; padding: 6px 12px; background: #f5f0f1; border-radius: 8px; min-width: 50px;"><div style="font-size: 0.65rem; color: #888;">T${i+1}</div><div style="font-weight: 700; color: #1a1a1a;">${w}</div></div>`;
                    });
                    html += `</div>`;
                    html += `<div style="font-size: 0.75rem; color: #888; margin-top: 6px;">T1 = competent • T3 = strong • Higher tiers not expected</div></div>`;
                }
                
                // Always show criteria even for test state
                html += `<div style="margin-bottom: 12px;">`;
                html += `<div style="font-weight: 600; color: #874B46; font-size: 0.85rem; margin-bottom: 8px;">✓ Form Criteria</div>`;
                pattern.criteria.forEach(c => {
                    html += `<div style="display: flex; gap: 8px; padding: 4px 0; font-size: 0.85rem;"><span style="color: #22c55e;">•</span><span style="color: #444;">${c.text} <span style="color: #888;">— ${c.note}</span></span></div>`;
                });
                html += `</div>`;
            } else {
                // Normal level view - show exercise, video, criteria
                const exercise = pattern.exercises[displayLevel];
                const isCompleted = displayLevel <= techLevel;
                
                if (exercise) {
                    html += `<div style="display: flex; align-items: center; gap: 10px; margin-bottom: 12px;">`;
                    html += `<div style="font-size: 0.85rem; color: #888;">Level ${displayLevel}</div>`;
                    html += `<div style="font-size: 1rem; font-weight: 600; color: #231F20;">${exercise.name}</div>`;
                    if (isCompleted) {
                        html += `<span style="background: rgba(34,197,94,0.15); color: #22c55e; padding: 2px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 600;">✓ Passed</span>`;
                    }
                    html += `</div>`;
                    
                    // Video
                    if (exercise.video) {
                        const videoId = exercise.video.split('/embed/')[1];
                        html += `<div style="border-radius: 10px; overflow: hidden; margin-bottom: 12px; aspect-ratio: 16/9; max-width: 400px; background: #000;">`;
                        html += `<div id="detailVidWrapper-${index}" style="width: 100%; height: 100%; cursor: pointer; position: relative;" onclick="playVideo(this, '${videoId}')">`;
                        html += `<img src="https://img.youtube.com/vi/${videoId}/hqdefault.jpg" style="width: 100%; height: 100%; object-fit: cover;">`;
                        html += `<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 56px; height: 56px; background: rgba(0,0,0,0.7); border-radius: 50%; display: flex; align-items: center; justify-content: center;"><span style="color: #fff; font-size: 22px; margin-left: 3px;">▶</span></div>`;
                        html += `</div>`;
                        html += `</div>`;
                    }
                    
                    // Always show criteria as a reference
                    html += `<div style="margin-bottom: 12px;">`;
                    html += `<div style="font-weight: 600; color: #874B46; font-size: 0.85rem; margin-bottom: 8px;">✓ Form Criteria</div>`;
                    pattern.criteria.forEach(c => {
                        html += `<div style="display: flex; gap: 8px; padding: 4px 0; font-size: 0.85rem;"><span style="color: #22c55e;">•</span><span style="color: #444;">${c.text} <span style="color: #888;">— ${c.note}</span></span></div>`;
                    });
                    html += `</div>`;
                }
            }
            
            html += `</div>`;
            panel.innerHTML = html;
            panel.style.display = 'block';
        }

        function selectPattern(index) {
            togglePatternDetail(index);
        }
        
        function scrollToAssessmentAndSelect(patternIndex) {
            // Scroll to the progress tiles area
            const grid = document.getElementById('progressGrid');
            if (grid) {
                grid.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            setTimeout(() => togglePatternDetail(patternIndex), 300);
        }

        function updateSelectedPattern() {
            // Legacy stub — assessment detail now handled by togglePatternDetail
        }

        function renderTestLevel() {}
        function renderCriteria() {}
        function changeLevel(delta) {}
        // ============================================
        // WORKOUT PLAN - VISUAL BLOCKS
        // ============================================
        // Fetch the current available session from config
        async function fetchCurrentSession() {
            try {
                const response = await fetch(`${APPS_SCRIPT_URL}?action=getConfig&key=CurrentSession`);
                const data = await response.json();
                if (data.success && data.value) {
                    return parseInt(data.value) || 1;
                }
            } catch (error) {
                console.error('Error fetching current session:', error);
            }
            return 1;
        }
        
        async function loadWorkoutPlan() {
            // Show loading state
            document.getElementById('workoutLoading').style.display = 'flex';
            document.getElementById('sessionNotStarted').style.display = 'none';
            document.getElementById('workoutBlockContainer').style.display = 'none';
            document.getElementById('sessionBadge').textContent = 'Loading...';

            try {
                // Get available session from config (set by teacher in admin panel)
                maxAvailableSession = await fetchCurrentSession();
                console.log('📋 Max available session from config:', maxAvailableSession);
                
                // Get last session to determine next session
                const lastSession = await fetchLastSession(currentUser.athleteId);
                console.log('📋 Last session for student:', lastSession);
                
                // Session numbering: admin unlocks the Nth workout overall
                // Workout 1=1A, 2=1B, 3=2A, 4=2B, 5=3A, 6=3B, 7=4A, 8=4B...
                // Internal index is 0-based: 0=1A, 1=1B, 2=2A, 3=2B, 4=3A...
                // Admin unlock 5 means "we're up to the 5th workout" = 3A
                const currentInternalSession = maxAvailableSession - 1; // 0-based index
                currentSessionNumber = currentInternalSession;
                
                // Convert internal index to display: pair number + A/B
                const displayNum = Math.floor(currentInternalSession / 2) + 1;
                currentSessionType = (currentInternalSession % 2 === 0) ? 'A' : 'B';
                currentSession = currentInternalSession;
                
                console.log('📋 Admin unlocked workout:', maxAvailableSession, '→ internal:', currentInternalSession, '→ display:', displayNum + currentSessionType);

                // Update UI with correct display number
                const displayLabel = displayNum + currentSessionType;
                document.getElementById('sessionBadge').textContent = `Session ${displayLabel}`;
                document.getElementById('nextSessionType').textContent = displayLabel;
                
                // Render session selector buttons
                renderSessionSelector();

                // Update stats counter
                // Fetch session stats from workout history
                console.log('📊 Fetching stats for athleteId:', currentUser.athleteId);
                const allHistory = await fetchWorkoutHistory(currentUser.athleteId, 100);
                console.log('📊 Stats history returned:', allHistory.length, 'sessions');
                const totalSessions = allHistory.length;
                let totalReps = 0;
                allHistory.forEach(session => {
                    // Try to count reps from exercises JSON
                    try {
                        let exercises = session.exercises;
                        if (typeof exercises === 'string') exercises = JSON.parse(exercises);
                        if (Array.isArray(exercises)) {
                            exercises.forEach(ex => {
                                const sets = parseInt(ex.sets) || 0;
                                const reps = parseInt(ex.reps) || 0;
                                totalReps += sets * reps;
                            });
                        }
                    } catch(e) {}
                });
                document.getElementById('totalSessions').textContent = totalSessions;
                document.getElementById('totalReps').textContent = totalReps;

                // Update progress tiles with practice counts from history
                updateProgressTilesWithPractice(allHistory);

                // Fetch last session of same type to show "Last time" data
                const lastSameTypeSession = await fetchLastSessionByType(currentUser.athleteId, currentSessionType);
                
                // Build workout blocks based on session type
                buildWorkoutBlocks(currentStrength, currentSessionType, lastSameTypeSession, allHistory);

                // Check for a saved session (page refresh recovery)
                const savedSession = loadSessionFromStorage();
                if (savedSession && savedSession.athleteId === currentUser.athleteId 
                    && savedSession.currentSessionNumber === currentSessionNumber
                    && savedSession.strengthHash === getStrengthHash()) {
                    // Restore the in-progress session
                    document.getElementById('workoutLoading').style.display = 'none';
                    restoreSessionState(savedSession);
                } else {
                    // No saved session, or data changed since save - start fresh
                    if (savedSession) {
                        if (savedSession.strengthHash !== getStrengthHash()) {
                            console.log('⚠️ Strength data changed since last save — starting fresh');
                        }
                        clearSessionStorage();
                    }
                    document.getElementById('workoutLoading').style.display = 'none';
                    document.getElementById('sessionNotStarted').style.display = 'block';
                }

            } catch (error) {
                console.error('Error loading workout plan:', error);
                document.getElementById('workoutLoading').innerHTML = `
                    <div style="color: #ef4444;">⚠️ Error loading workout</div>
                    <div class="workout-loading-subtext">Please refresh the page</div>
                `;
            }
        }

        function buildWorkoutBlocks(strength, sessionType, lastSession, allHistory) {
            workoutBlocks = [];
            
            // Count practices per pattern from workout history
            // Only count sessions where they practiced the SPECIFIC exercise for their next level
            // e.g. at tech level 2 for Squat, count sessions with "Back Squat" (level 3 exercise)
            const practiceCounts = {};
            const nextExerciseNames = {};
            patterns.forEach(pattern => {
                practiceCounts[pattern.name] = 0;
                const techLevel = parseInt(strength?.[pattern.name + '_Tech']) || 0;
                const nextLevel = techLevel + 1;
                const nextEx = pattern.exercises[nextLevel];
                nextExerciseNames[pattern.name] = nextEx ? nextEx.name : null;
            });
            
            if (allHistory && allHistory.length > 0) {
                allHistory.forEach(session => {
                    try {
                        let exercises = session.exercises;
                        if (typeof exercises === 'string') exercises = JSON.parse(exercises);
                        if (Array.isArray(exercises)) {
                            const practicedInSession = new Set();
                            exercises.forEach(ex => {
                                // Match by exact exercise name for the next level
                                if (ex.pattern && nextExerciseNames[ex.pattern] && ex.name === nextExerciseNames[ex.pattern]) {
                                    practicedInSession.add(ex.pattern);
                                }
                            });
                            practicedInSession.forEach(p => practiceCounts[p]++);
                        }
                    } catch(e) {}
                });
            }
            console.log('📊 Practice counts (next-level exercise):', practiceCounts, 'Looking for:', nextExerciseNames);
            
            // Baseline: students who passed levels 1 & 2 already did those practices.
            // But they still need fresh practices for the NEXT level they're working toward.
            // The practice count from history only tracks 'technique' type exercises,
            // which are the next-level movements in the technique practice block.
            // So we DON'T inflate the count here - the history count is accurate for next-level practices.
            // Only override if somehow old data counted non-technique exercises.
            // Parse last session exercises to find previous weights
            let lastExercises = {};
            if (lastSession && lastSession.exercises) {
                try {
                    const parsed = typeof lastSession.exercises === 'string' 
                        ? JSON.parse(lastSession.exercises) 
                        : lastSession.exercises;
                    parsed.forEach(ex => {
                        if (ex.pattern) {
                            lastExercises[ex.pattern] = {
                                weight: ex.weight,
                                sets: ex.sets,
                                reps: ex.reps
                            };
                        }
                    });
                } catch (e) {
                    console.error('Error parsing last session exercises:', e);
                }
            }
            
            // Session A: Squat, Push, Lunge (3 patterns)
            // Session B: Hinge, Pull, Press (3 patterns)
            // No overlap - each pattern appears once per A/B cycle
            let primaryPatterns, accessoryPatterns;
            
            if (sessionType === 'A') {
                primaryPatterns = ['Squat', 'Push'];
                accessoryPatterns = ['Lunge'];
            } else {
                primaryPatterns = ['Hinge', 'Pull'];
                accessoryPatterns = ['Press'];
            }

            // Block 1: Warm-up (condensed single card)
            workoutBlocks.push({
                type: 'warmup',
                title: '🔥 WARM-UP',
                subtitle: '8-10 minutes',
                exercises: [
                    { 
                        name: 'Complete Warm-Up Routine', 
                        isWarmupCard: true,
                        warmupItems: [
                            { icon: '🏃', name: 'General Warm-Up', detail: '3-5 min light cardio' },
                            { icon: '🌍', name: 'World\'s Greatest Stretch', detail: '5 reps each side' },
                            { icon: '⚡', name: 'Plyos', detail: 'See Mr. Bain' },
                            { icon: '🛡️', name: 'Prehab', detail: 'See Mr. Bain' }
                        ],
                        sets: 1,
                        reps: 0,
                        completed: [false]
                    }
                ]
            });

            // Primary lift blocks
            primaryPatterns.forEach((patternName, index) => {
                const pattern = patterns.find(p => p.name === patternName);
                const techKey = pattern.name + '_Tech';
                const strKey = pattern.name + '_Str';
                const techLevel = parseInt(strength?.[techKey]) || 0;
                const strengthTier = parseInt(strength?.[strKey]) || 0;
                const gender = strength?.Gender || 'M';
                
                // Look up actual weight from tier
                const loadTiers = gender === 'F' ? pattern.loadTiers.F : pattern.loadTiers.M;
                const actual5RM = strengthTier > 0 ? loadTiers[strengthTier - 1] : 0;
                
                // Exercise level: use their completed level (minimum 1)
                const exerciseLevel = Math.max(techLevel, 1);
                const exercise = pattern.exercises[exerciseLevel];
                
                // Determine training state
                let trainingState = 'technique'; // Default: working on technique
                let workingWeight = 0;
                
                // Pull is rep-based, so no weight calculation
                const isRepBased = pattern.testType === 'reps';
                
                if (techLevel >= 2 && strengthTier > 0) {
                    // Has passed Level 2 AND has strength score = loaded training
                    trainingState = 'loaded';
                    if (isRepBased) {
                        // Pull: workingWeight is used as a flag to show rep display
                        // Set to tier max so the display can reference it
                        workingWeight = actual5RM; // actual5RM = tier reps for rep-based
                    } else {
                        workingWeight = roundToAvailableWeight(actual5RM * 0.7, exercise.name);
                    }
                } else if (techLevel >= 2 && strengthTier === 0) {
                    // Has passed Level 2 but no strength score = ready to test
                    trainingState = 'readyToTest';
                    // Suggest Tier 1 weight for practice
                    if (!isRepBased) {
                        workingWeight = loadTiers[0]; // Tier 1 entry weight
                    }
                }
                // else techLevel < 2 = technique focus (default)
                
                // Reps: for rep-based loaded, use 70% of tier max; otherwise 8 (or 5 for test)
                let reps;
                if (isRepBased && trainingState === 'loaded' && actual5RM > 0) {
                    reps = Math.round(actual5RM * 0.7);
                } else {
                    reps = trainingState === 'readyToTest' ? 5 : 8;
                }
                
                // Get last session data for this pattern
                const lastData = lastExercises[patternName];
                let lastTimeInfo = null;
                let suggestedWeight = workingWeight;
                let progressionEligible = null;
                
                if (lastData && lastData.weight && lastData.weight !== 'bodyweight') {
                    const lastWeight = parseFloat(lastData.weight) || 0;
                    lastTimeInfo = {
                        weight: lastWeight,
                        sets: lastData.sets,
                        reps: lastData.reps
                    };
                    
                    // Check if eligible for progression (don't auto-apply, just flag it)
                    if (trainingState === 'loaded' && lastData.sets >= 3 && lastWeight > 0) {
                        progressionEligible = checkProgressionEligibility(
                            patternName, exercise.name, lastData, allHistory, sessionType, isRepBased
                        );
                        
                        // Keep them at last weight (don't auto-bump) - they'll be prompted
                        suggestedWeight = lastWeight;
                    }
                }
                
                console.log(`💪 PRIMARY ${patternName}: techLevel=${techLevel}, strTier=${strengthTier}, actual5RM=${actual5RM}, workingWt=${workingWeight}, suggestedWt=${suggestedWeight}, state=${trainingState}, exercise=${exercise?.name}, progressionEligible=`, progressionEligible);
                
                workoutBlocks.push({
                    type: 'primary',
                    title: `💪 PRIMARY LIFT ${index + 1}`,
                    subtitle: patternName + ' Pattern',
                    pattern: pattern,
                    techLevel: techLevel,
                    trainingState: trainingState,
                    exercises: [{
                        name: exercise.name,
                        video: exercise.video,
                        patternName: patternName,
                        sets: 3,
                        reps: reps,
                        weight: suggestedWeight,
                        lastTime: lastTimeInfo,
                        trainingState: trainingState,
                        isDumbbell: exercise.name.toLowerCase().includes('dumbbell') || exercise.name.toLowerCase().includes('db '),
                        completed: [false, false, false],
                        progressionEligible: progressionEligible
                    }]
                });
            });

            // Accessory lift blocks
            accessoryPatterns.forEach((patternName, index) => {
                const pattern = patterns.find(p => p.name === patternName);
                const techKey = pattern.name + '_Tech';
                const strKey = pattern.name + '_Str';
                const techLevel = parseInt(strength?.[techKey]) || 0;
                const strengthTier = parseInt(strength?.[strKey]) || 0;
                const gender = strength?.Gender || 'M';
                
                // Look up actual weight from tier
                const loadTiers = gender === 'F' ? pattern.loadTiers.F : pattern.loadTiers.M;
                const actual5RM = strengthTier > 0 ? loadTiers[strengthTier - 1] : 0;
                
                // Exercise level: use their completed level (minimum 1)
                const exerciseLevel = Math.max(techLevel, 1);
                const exercise = pattern.exercises[exerciseLevel];
                
                // Determine training state
                let trainingState = 'technique';
                let workingWeight = 0;
                
                // Pull is rep-based, so no weight calculation
                const isRepBased = pattern.testType === 'reps';
                
                if (techLevel >= 2 && strengthTier > 0) {
                    trainingState = 'loaded';
                    if (isRepBased) {
                        // Pull: workingWeight is used as a flag to show rep display
                        workingWeight = actual5RM;
                    } else {
                        // Accessory at 56% of 5RM (80% of 70%)
                        workingWeight = roundToAvailableWeight(actual5RM * 0.56, exercise.name);
                    }
                } else if (techLevel >= 2 && strengthTier === 0) {
                    trainingState = 'readyToTest';
                    // Suggest Tier 1 weight for practice
                    if (!isRepBased) {
                        workingWeight = loadTiers[0]; // Tier 1 entry weight
                    }
                }
                
                // Reps: for rep-based loaded, use 70% of tier max; otherwise 10 (or 5 for test)
                let reps;
                if (isRepBased && trainingState === 'loaded' && actual5RM > 0) {
                    reps = Math.round(actual5RM * 0.7);
                } else {
                    reps = trainingState === 'readyToTest' ? 5 : 10;
                }
                
                // Get last session data for this pattern
                const lastData = lastExercises[patternName];
                let lastTimeInfo = null;
                let suggestedWeight = workingWeight;
                let progressionEligible = null;
                
                if (lastData && lastData.weight && lastData.weight !== 'bodyweight') {
                    const lastWeight = parseFloat(lastData.weight) || 0;
                    lastTimeInfo = {
                        weight: lastWeight,
                        sets: lastData.sets,
                        reps: lastData.reps
                    };
                    
                    // Check if eligible for progression (don't auto-apply, just flag it)
                    if (trainingState === 'loaded' && lastData.sets >= 3 && lastWeight > 0) {
                        progressionEligible = checkProgressionEligibility(
                            patternName, exercise.name, lastData, allHistory, sessionType, isRepBased
                        );
                        
                        // Keep them at last weight (don't auto-bump) - they'll be prompted
                        suggestedWeight = lastWeight;
                    }
                }
                
                console.log(`🎯 ACCESSORY ${patternName}: techLevel=${techLevel}, strTier=${strengthTier}, actual5RM=${actual5RM}, workingWt=${workingWeight}, suggestedWt=${suggestedWeight}, state=${trainingState}, exercise=${exercise?.name}, progressionEligible=`, progressionEligible);
                
                workoutBlocks.push({
                    type: 'accessory',
                    title: `🎯 ACCESSORY ${index + 1}`,
                    subtitle: patternName + ' Pattern',
                    pattern: pattern,
                    techLevel: techLevel,
                    trainingState: trainingState,
                    exercises: [{
                        name: exercise.name,
                        video: exercise.video,
                        patternName: patternName,
                        sets: 3,
                        reps: reps,
                        weight: suggestedWeight,
                        lastTime: lastTimeInfo,
                        trainingState: trainingState,
                        isDumbbell: exercise.name.toLowerCase().includes('dumbbell') || exercise.name.toLowerCase().includes('db '),
                        completed: [false, false, false],
                        progressionEligible: progressionEligible
                    }]
                });
            });

            // Core block - Progressive by session number
            // Sessions 1A, 2B: Plank + Dead Bug (foundational)
            // Sessions 3A onwards: Sit Up + Hip Extension
            // Core progression: pairs 1-2 = Plank + Dead Bug, pair 3+ = Sit Up + Hip Extension
            const currentPairNum = Math.floor(currentSessionNumber / 2) + 1;
            const useAdvancedCore = currentPairNum >= 3;
            
            const coreExercise1 = useAdvancedCore ? {
                name: 'Sit Up',
                video: 'https://www.youtube.com/embed/f9Yi_74xF_c',
                instructions: [
                    'Feet flat on the floor, knees bent',
                    'Hands behind head or across chest',
                    'Curl up fully, controlled descent'
                ],
                sets: 3,
                reps: 10,
                isTimeBased: false,
                completed: [false, false, false]
            } : {
                name: 'Plank Hold',
                video: 'https://www.youtube.com/embed/ao5nY7lb088',
                instructions: [
                    'Keep body in straight line',
                    'Engage core, squeeze glutes',
                    'Don\'t let hips sag or pike up'
                ],
                sets: 2,
                reps: 0,
                duration: 45,
                isTimeBased: true,
                completed: [false, false],
                nextExercise: 'Sit Up (from Session 3)'
            };
            
            const coreExercise2 = useAdvancedCore ? {
                name: 'Hip Extension',
                video: 'https://www.youtube.com/embed/yNvAeCrTFuk',
                instructions: [
                    'Lie face down on a bench, hips at edge',
                    'Lift legs to horizontal, squeeze glutes',
                    'Controlled lower, don\'t hyperextend'
                ],
                sets: 3,
                reps: 8,
                isTimeBased: false,
                completed: [false, false, false]
            } : {
                name: 'Dead Bug',
                video: 'https://www.youtube.com/embed/-VykQ1HD0Vw',
                instructions: [
                    'Keep lower back pressed to floor',
                    'Extend opposite arm and leg',
                    'Controlled movement, no rushing'
                ],
                sets: 2,
                reps: 10,
                repsNote: 'each side',
                isTimeBased: false,
                completed: [false, false],
                nextExercise: 'Hip Extension (from Session 3)'
            };
            
            workoutBlocks.push({
                type: 'core',
                title: '🧘 CORE',
                subtitle: coreExercise1.sets + ' sets each',
                exercises: [coreExercise1, coreExercise2]
            });

            // Technique Practice block - show patterns that still need technique work
            // EXCLUDE patterns already in this workout session
            const workoutPatternNames = [...primaryPatterns, ...accessoryPatterns];
            const PRACTICES_TO_FILM = 3; // Sessions before "ready to film" unlocks
            
            const techniquePracticeExercises = [];
            patterns.forEach(pattern => {
                // Skip if this pattern is already in the workout
                if (workoutPatternNames.includes(pattern.name)) return;
                
                const techLevel = parseInt(strength?.[pattern.name + '_Tech']) || 0;
                const strTier = parseInt(strength?.[pattern.name + '_Str']) || 0;
                const hasStrength = strTier > 0;
                
                // Only include if not at max level (5) and not in testing state
                if (techLevel < 5) {
                    const isReadyToTest = techLevel >= 2 && !hasStrength;
                    
                    if (!isReadyToTest) {
                        // They're working on next level
                        const nextLevel = techLevel + 1;
                        const exercise = pattern.exercises[nextLevel];
                        if (exercise) {
                            const practices = practiceCounts[pattern.name] || 0;
                            const readyToFilm = practices >= PRACTICES_TO_FILM;
                            techniquePracticeExercises.push({
                                patternKey: pattern.key,
                                patternName: pattern.name,
                                name: exercise.name,
                                video: exercise.video,
                                level: nextLevel,
                                techLevel: techLevel,
                                practices: practices,
                                readyToFilm: readyToFilm,
                                criteria: pattern.criteria
                            });
                        }
                    }
                }
            });

            // Limit to max 2 technique practice exercises
            const limitedTechPractice = techniquePracticeExercises.slice(0, 2);

            if (limitedTechPractice.length > 0) {
                workoutBlocks.push({
                    type: 'technique',
                    title: '🎯 MOVEMENT PRACTICE',
                    subtitle: 'Build your skills with quality reps',
                    exercises: limitedTechPractice.map(ex => ({
                        name: ex.name,
                        video: ex.video,
                        patternName: ex.patternName,
                        level: ex.level,
                        patternKey: ex.patternKey,
                        currentTech: ex.techLevel,
                        practices: ex.practices,
                        readyToFilm: ex.readyToFilm,
                        practicesNeeded: PRACTICES_TO_FILM,
                        criteria: ex.criteria,
                        sets: 1,
                        reps: 0,
                        completed: [false],
                        linkToAssessment: true
                    }))
                });
            }

            // Summary block
            workoutBlocks.push({
                type: 'summary',
                title: '✅ SESSION COMPLETE',
                subtitle: 'Great work!'
            });
        }

        function renderSessionSelector() {
            const container = document.getElementById('sessionButtons');
            if (!container) return;
            
            // Show all unlocked workouts: 1A, 1B, 2A, 2B, 3A...
            let html = '';
            for (let i = 0; i < maxAvailableSession; i++) {
                const pairNum = Math.floor(i / 2) + 1;
                const type = (i % 2 === 0) ? 'A' : 'B';
                const label = pairNum + type;
                const isCurrent = i === currentSessionNumber;
                html += `<button onclick="switchToSession(${i})" style="
                    padding: 8px 16px;
                    border-radius: 20px;
                    border: 2px solid ${isCurrent ? '#874B46' : '#ddd'};
                    background: ${isCurrent ? '#874B46' : '#fff'};
                    color: ${isCurrent ? '#fff' : '#555'};
                    font-weight: ${isCurrent ? '700' : '500'};
                    font-size: 0.9rem;
                    cursor: pointer;
                    font-family: inherit;
                    transition: all 0.2s;
                " onmouseover="if(!${isCurrent})this.style.borderColor='#874B46'" 
                   onmouseout="if(!${isCurrent})this.style.borderColor='#ddd'"
                >${label}</button>`;
            }
            container.innerHTML = html;
        }
        
        async function switchToSession(internalNum) {
            currentSessionNumber = internalNum;
            currentSessionType = (internalNum % 2 === 0) ? 'A' : 'B';
            currentSession = internalNum;
            
            const pairNum = Math.floor(internalNum / 2) + 1;
            const displayLabel = pairNum + currentSessionType;
            
            // Update UI badge
            document.getElementById('sessionBadge').textContent = `Session ${displayLabel}`;
            document.getElementById('nextSessionType').textContent = displayLabel;
            
            // Stop any running timer
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }
            sessionStartTime = null;
            
            // Clear any saved session state
            clearSessionStorage();
            
            // Reset all UI states back to "not started"
            const container = document.getElementById('workoutBlockContainer');
            container.style.display = 'none';
            container.innerHTML = '<div class="workout-block" id="currentBlock"></div>';
            document.getElementById('sessionTimer').style.display = 'none';
            document.getElementById('completeSessionBtn').style.display = 'none';
            document.getElementById('sessionNotStarted').style.display = 'block';
            
            // Fetch last session of this type for "last time" data
            const lastSameTypeSession = await fetchLastSessionByType(currentUser.athleteId, currentSessionType);
            
            // Rebuild workout blocks
            buildWorkoutBlocks(currentStrength, currentSessionType, lastSameTypeSession);
            
            // Re-render selector to show new current
            renderSessionSelector();
            
            showToast(`Switched to Session ${displayLabel}`, 'success');
        }

        function startSession() {
            // Record start time
            sessionStartTime = Date.now();
            slothShown = false;
            currentBlockIndex = 0;
            
            // Reset all block completion states
            workoutBlocks.forEach(block => {
                if (block.exercises) {
                    block.exercises.forEach(ex => {
                        ex.completed = ex.completed.map(() => false);
                    });
                }
            });

            // Update UI
            document.getElementById('sessionNotStarted').style.display = 'none';
            document.getElementById('workoutBlockContainer').style.display = 'block';
            document.getElementById('sessionTimer').style.display = 'flex';
            document.getElementById('completeSessionBtn').style.display = 'none';

            // Start timer
            updateTimer();
            sessionTimer = setInterval(updateTimer, 1000);

            // Render first block
            renderCurrentBlock();

            // Save to localStorage
            saveSessionToStorage();

            showToast('Session started! Take your time.', 'success');
        }

        function updateTimer() {
            if (!sessionStartTime) return;
            
            const elapsed = Date.now() - sessionStartTime;
            const minutes = Math.floor(elapsed / 60000);
            const seconds = Math.floor((elapsed % 60000) / 1000);
            
            document.getElementById('timerDisplay').textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function renderCurrentBlock() {
            const block = workoutBlocks[currentBlockIndex];
            const container = document.getElementById('currentBlock');
            
            // Generate progress dots
            const dots = workoutBlocks.map((b, i) => {
                let dotClass = 'progress-dot';
                if (i === currentBlockIndex) dotClass += ' active';
                if (i < currentBlockIndex || isBlockComplete(i)) dotClass += ' completed';
                return `<div class="${dotClass}" onclick="goToBlock(${i})"></div>`;
            }).join('');

            if (block.type === 'summary') {
                renderSummaryBlock(container, dots);
                return;
            }

            let content = `
                <div class="block-header">
                    <button class="block-nav-btn" onclick="prevBlock()" ${currentBlockIndex === 0 ? 'disabled' : ''}>
                        ◀ Back
                    </button>
                    <div class="block-title-area">
                        <div class="block-title">${block.title}</div>
                        <div class="block-subtitle">${block.subtitle}</div>
                        <div class="block-progress-dots">${dots}</div>
                    </div>
                    <button class="block-nav-btn" onclick="nextBlock()">
                        Next ▶
                    </button>
                </div>
            `;

            // Render exercises in this block
            block.exercises.forEach((exercise, exIndex) => {
                content += renderExerciseInBlock(block, exercise, exIndex);
            });

            container.innerHTML = content;
        }

        function renderExerciseInBlock(block, exercise, exIndex) {
            let html = '';
            
            // Special warm-up card rendering
            if (exercise.isWarmupCard) {
                html += `
                    <div class="warmup-card" style="
                        background: #fff;
                        border: 2px solid rgba(249, 115, 22, 0.3);
                        border-radius: 16px;
                        padding: 20px;
                        margin-bottom: 15px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
                    ">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            ${exercise.warmupItems.map(item => `
                                <div style="
                                    background: #f5f0f1;
                                    border: 1px solid rgba(0,0,0,0.08);
                                    border-radius: 12px;
                                    padding: 14px;
                                    display: flex;
                                    align-items: center;
                                    gap: 12px;
                                ">
                                    <div style="font-size: 1.5rem;">${item.icon}</div>
                                    <div>
                                        <div style="font-weight: 600; color: #ea580c; font-size: 0.9rem;">${item.name}</div>
                                        <div style="color: #666; font-size: 0.8rem;">${item.detail}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                // Single checkbox for entire warmup
                html += `
                    <div class="sets-grid" style="justify-content: center;">
                        <div class="set-item" style="min-width: 150px;">
                            <div class="set-checkbox ${exercise.completed[0] ? 'checked' : ''}" 
                                 onclick="toggleSet(${exIndex}, 0)">
                            </div>
                            <div class="set-label">Warm-up Complete</div>
                        </div>
                    </div>
                `;
                return html;
            }
            
            // Special handling for technique practice links
            if (exercise.linkToAssessment) {
                const patternIndex = patterns.findIndex(p => p.key === exercise.patternKey);
                const practices = exercise.practices || 0;
                
                // Header with pattern name + practice count
                html += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 700; font-size: 1.15rem; color: #1a1a1a;">${exercise.patternName}</div>
                                <div style="color: #888; font-size: 0.85rem;">Level ${exercise.currentTech} → Level ${exercise.level} · <strong style="color: #874B46;">${exercise.name}</strong></div>
                            </div>
                            <div style="text-align: center; min-width: 55px;">
                                <div style="font-size: 1.4rem; font-weight: 800; color: #874B46;">${practices}</div>
                                <div style="font-size: 0.65rem; color: #888;">practices</div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Video demo
                if (exercise.video) {
                    const videoId = exercise.video.split('/embed/')[1];
                    html += `
                        <div style="border-radius: 12px; overflow: hidden; margin-bottom: 15px; aspect-ratio: 16/9; max-width: 450px; margin-left: auto; margin-right: auto; background: #000;">
                            <div id="techVidWrapper-${exIndex}" style="width: 100%; height: 100%; cursor: pointer; position: relative;" onclick="playVideo(this, '${videoId}')">
                                <img src="https://img.youtube.com/vi/${videoId}/hqdefault.jpg" style="width: 100%; height: 100%; object-fit: cover;">
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 56px; height: 56px; background: rgba(0,0,0,0.7); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <span style="color: #fff; font-size: 22px; margin-left: 3px;">▶</span>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                // Practice focus - show form criteria
                html += `
                    <div style="background: rgba(135,75,70,0.06); border: 1px solid rgba(135,75,70,0.15); border-radius: 12px; padding: 14px; margin-bottom: 15px;">
                        <div style="font-size: 0.85rem; color: #555; line-height: 1.6; margin-bottom: 8px;">
                            <strong>Focus on quality reps.</strong> Check these form cues:
                        </div>
                        <div>
                            ${(exercise.criteria || []).slice(0, 4).map(c => `<div style="font-size: 0.8rem; color: #666; padding: 2px 0;">• ${c.text}</div>`).join('')}
                        </div>
                    </div>
                `;
                
                // Record practice + completion checkbox
                html += `
                    <div style="margin-top: 10px;">
                        <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                            <div style="flex: 1;">
                                <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 4px;">Sets</label>
                                <input type="number" id="techSets-${exIndex}" value="2" min="1" max="5" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; font-weight: 600; text-align: center; font-family: inherit;">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 0.75rem; color: #666; display: block; margin-bottom: 4px;">Reps per set</label>
                                <input type="number" id="techReps-${exIndex}" value="8" min="1" max="30" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 1rem; font-weight: 600; text-align: center; font-family: inherit;">
                            </div>
                        </div>
                    </div>
                    <div class="sets-grid" style="justify-content: center;">
                        <div class="set-item">
                            <div class="set-checkbox ${exercise.completed[0] ? 'checked' : ''}" 
                                 onclick="toggleSet(${exIndex}, 0)">
                            </div>
                            <div class="set-label">Done</div>
                        </div>
                    </div>
                `;
                return html;
            }
            // Video thumbnail (clickable link to YouTube) or instructions
            else if (exercise.video) {
                const videoId = exercise.video.split('/embed/')[1];
                const watchUrl = `https://www.youtube.com/watch?v=${videoId}`;
                html += `
                    <a href="${watchUrl}" target="_blank" class="block-video-container" style="display: block; text-decoration: none;">
                        <div class="video-thumbnail-wrapper">
                            <img src="https://img.youtube.com/vi/${videoId}/hqdefault.jpg" alt="${exercise.name}">
                            <div class="video-play-btn"><span>▶</span></div>
                            <div style="position: absolute; bottom: 10px; right: 10px; background: rgba(0,0,0,0.8); color: #231F20; padding: 5px 10px; border-radius: 5px; font-size: 0.75rem;">
                                Watch on YouTube ↗
                            </div>
                        </div>
                    </a>
                `;
            } else if (exercise.instructions) {
                html += `
                    <div class="block-instructions">
                        <h4>📋 ${exercise.name}</h4>
                        <ul>
                            ${exercise.instructions.map(i => `<li>${i}</li>`).join('')}
                        </ul>
                    </div>
                `;
                // Show progression hint if this core exercise has a next step
                if (exercise.nextExercise) {
                    html += `
                        <div style="background: rgba(135, 75, 70, 0.06); border: 1px dashed rgba(135, 75, 70, 0.3); border-radius: 10px; padding: 10px 15px; margin-bottom: 10px; font-size: 0.8rem; color: #874B46;">
                            📈 <strong>Next progression:</strong> ${exercise.nextExercise} — keep building consistency here first
                        </div>
                    `;
                }
            }

            // Exercise info with training state badge
            let stateBadge = '';
            let topBadge = '';
            if (exercise.trainingState === 'technique') {
                stateBadge = `<div style="display: inline-block; background: rgba(245, 158, 11, 0.2); color: #fbbf24; padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; margin-top: 10px;">
                    🎯 TECHNIQUE FOCUS - Pass Level 2 to unlock strength testing
                </div>`;
            } else if (exercise.trainingState === 'readyToTest') {
                // Green prominent badge at top
                topBadge = `<div style="background: linear-gradient(135deg, #22c55e, #16a34a); color: #231F20; padding: 12px 20px; border-radius: 12px; font-size: 0.95rem; font-weight: 600; margin-bottom: 15px; text-align: center; box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);">
                    ✅ READY TO TEST — Practice the movement first. Speak to Mr. Bain when you're ready to test.
                </div>`;
            }

            // Show top badge first if exists
            if (topBadge) {
                html += topBadge;
            }

            html += `
                <div class="block-exercise-info">
                    <div class="block-exercise-name">${exercise.name}</div>
                    <div class="block-exercise-details">
                        ${exercise.isTimeBased 
                            ? `${exercise.sets} ${exercise.sets === 1 ? 'set' : 'sets'} × ${exercise.duration} seconds`
                            : `${exercise.sets} ${exercise.sets === 1 ? 'set' : 'sets'} × ${exercise.reps || 'complete'}${exercise.reps ? ' reps' : ''}${exercise.repsNote ? ' ' + exercise.repsNote : ''}`
                        }
                    </div>
                    ${exercise.patternName ? `<div class="block-exercise-pattern">${exercise.patternName} Pattern • Level ${block.techLevel}</div>` : ''}
                    ${stateBadge}
                </div>
            `;

            // Weight control (for loaded OR readyToTest with weight)
            // Skip weight display for rep-based patterns (Pull) - show rep target instead
            const patternDef = exercise.patternName ? patterns.find(p => p.name === exercise.patternName) : null;
            const isRepBasedPattern = patternDef && patternDef.testType === 'reps';
            
            if (isRepBasedPattern && exercise.weight > 0) {
                // Rep-based pattern (Pull): show rep target, not weight
                const gender = currentStrength?.Gender || 'M';
                const loadTiers = gender === 'F' ? patternDef.loadTiers.F : patternDef.loadTiers.M;
                const strTier = parseInt(currentStrength?.[exercise.patternName + '_Str']) || 0;
                const currentTierReps = strTier > 0 ? loadTiers[strTier - 1] : loadTiers[0];
                
                let lastTimeHtml = '';
                if (exercise.lastTime && exercise.lastTime.weight) {
                    lastTimeHtml = `
                        <div style="background: #f5f5f5; border: 1px solid #ddd; border-radius: 10px; padding: 10px 15px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <span style="color: #333; font-size: 0.9rem;">📊 Last time:</span>
                            <span style="color: #874B46; font-weight: 700;">${exercise.lastTime.weight} reps</span>
                            <span style="color: #555; font-size: 0.85rem;">× ${exercise.lastTime.sets} sets</span>
                        </div>
                    `;
                }
                
                html += lastTimeHtml;
                html += `
                    <div style="text-align: center; padding: 15px; background: rgba(135, 75, 70, 0.05); border-radius: 12px; margin-bottom: 15px;">
                        <div style="font-size: 2rem; font-weight: 800; color: #874B46;">Tier ${strTier > 0 ? strTier : 1}: ${currentTierReps} reps</div>
                        <div style="font-size: 0.8rem; color: #666; margin-top: 4px;">Aim for ${exercise.reps} reps × ${exercise.sets} sets (bodyweight)</div>
                    </div>
                `;
            } else if (exercise.weight > 0) {
                const weightLabel = exercise.trainingState === 'loaded' ? 'Working Weight (70%)' : 'Practice Weight (Tier 1)';
                
                // Use stored isDumbbell flag
                const isDumbbell = exercise.isDumbbell;
                
                // For dumbbells: tier weight is TOTAL, so show per-hand calculation
                let weightDisplayHtml;
                if (isDumbbell) {
                    const perHand = exercise.weight / 2;
                    weightDisplayHtml = `
                        <div class="block-weight-display" id="weight-${exIndex}">${perHand} kg <span style="font-size: 0.7em; opacity: 0.7;">each hand</span></div>
                        <div class="block-weight-label">${weightLabel}</div>
                        <div style="font-size: 0.75rem; color: #555; margin-top: 4px;">${exercise.weight}kg total (2 × ${perHand}kg)</div>
                    `;
                } else {
                    weightDisplayHtml = `
                        <div class="block-weight-display" id="weight-${exIndex}">${exercise.weight} kg</div>
                        <div class="block-weight-label">${weightLabel}</div>
                    `;
                }
                
                // Show "Last time" info if available
                let lastTimeHtml = '';
                if (exercise.lastTime && exercise.lastTime.weight) {
                    lastTimeHtml = `
                        <div style="background: #f5f5f5; border: 1px solid #ddd; border-radius: 10px; padding: 10px 15px; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;">
                            <span style="color: #333; font-size: 0.9rem;">📊 Last time:</span>
                            <span style="color: #874B46; font-weight: 700;">${exercise.lastTime.weight}kg</span>
                            <span style="color: #555; font-size: 0.85rem;">× ${exercise.lastTime.sets} sets</span>
                        </div>
                    `;
                }
                
                // Show progression prompt if eligible
                let progressionPromptHtml = '';
                if (exercise.progressionEligible && !exercise.progressionDeclined) {
                    const prog = exercise.progressionEligible;
                    const isReps = prog.type === 'reps';
                    progressionPromptHtml = `
                        <div style="background: linear-gradient(135deg, rgba(34,197,94,0.15), rgba(34,197,94,0.05)); border: 2px solid rgba(34,197,94,0.4); border-radius: 12px; padding: 15px; margin-bottom: 15px; text-align: center;">
                            <div style="font-size: 1.1rem; font-weight: 700; color: #16a34a; margin-bottom: 8px;">📈 Ready to Progress!</div>
                            <div style="color: #333; font-size: 0.9rem; margin-bottom: 12px;">
                                You've completed <strong>${prog.currentValue}${isReps ? ' reps' : 'kg'}</strong> for 
                                ${prog.consecutiveSessions} session${prog.consecutiveSessions > 1 ? 's' : ''} in a row
                            </div>
                            <div style="display: flex; gap: 10px; justify-content: center;">
                                <button onclick="triggerProgressionPrompt(${exIndex})" style="padding: 10px 20px; background: linear-gradient(135deg, #22c55e, #16a34a); color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.9rem;">
                                    Try ${prog.newValue}${isReps ? ' reps' : 'kg'} today! 💪
                                </button>
                                <button onclick="declineProgressionInline(${exIndex})" style="padding: 10px 16px; background: #f5f5f5; color: #666; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; font-size: 0.85rem;">
                                    Stay at ${prog.currentValue}${isReps ? ' reps' : 'kg'}
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                html += progressionPromptHtml;
                html += lastTimeHtml;
                html += `
                    <div class="block-weight-control">
                        <button class="block-weight-btn" onclick="adjustBlockWeight(${exIndex}, ${isDumbbell ? -2 : -2.5})">−</button>
                        <div>
                            ${weightDisplayHtml}
                        </div>
                        <button class="block-weight-btn" onclick="adjustBlockWeight(${exIndex}, ${isDumbbell ? 2 : 2.5})">+</button>
                    </div>
                `;
            }

            // Sets checkboxes
            html += `<div class="sets-grid">`;
            for (let i = 0; i < exercise.sets; i++) {
                const isChecked = exercise.completed[i];
                html += `
                    <div class="set-item">
                        <div class="set-checkbox ${isChecked ? 'checked' : ''}" 
                             onclick="toggleSet(${exIndex}, ${i})">
                        </div>
                        <div class="set-label">Set ${i + 1}</div>
                        ${exercise.isTimeBased 
                            ? `<div class="set-reps">${exercise.duration}s</div>`
                            : (exercise.reps ? `<div class="set-reps">${exercise.reps} reps${exercise.repsNote ? ' ' + exercise.repsNote : ''}</div>` : '')
                        }
                    </div>
                `;
            }
            html += `</div>`;

            // Tip based on training state
            if (block.type === 'primary' || block.type === 'accessory') {
                if (exercise.trainingState === 'technique') {
                    html += `
                        <div class="block-tip" style="background: rgba(245, 158, 11, 0.1);">
                            <div class="block-tip-text">💡 Focus on perfect form - control the movement through full range</div>
                        </div>
                    `;
                } else if (exercise.trainingState === 'loaded') {
                    html += `
                        <div class="block-tip">
                            <div class="block-tip-text">💡 Rest 90-120 seconds between sets for strength gains</div>
                        </div>
                    `;
                }
            }

            return html;
        }

        function renderSummaryBlock(container, dots) {
            // Calculate totals
            let totalRepsSession = 0;
            let completedExercises = [];
            
            workoutBlocks.forEach(block => {
                if (block.exercises) {
                    block.exercises.forEach(ex => {
                        const completedSets = ex.completed.filter(c => c).length;
                        const repsPerSet = ex.reps || 1;
                        totalRepsSession += completedSets * repsPerSet;
                        
                        if (completedSets > 0) {
                            completedExercises.push({
                                name: ex.name,
                                sets: completedSets,
                                totalSets: ex.sets,
                                weight: ex.weight || 'Bodyweight'
                            });
                        }
                    });
                }
            });

            const elapsed = sessionStartTime ? Math.round((Date.now() - sessionStartTime) / 60000) : 0;

            container.innerHTML = `
                <div class="block-header">
                    <button class="block-nav-btn" onclick="prevBlock()">◀ Back</button>
                    <div class="block-title-area">
                        <div class="block-title">✅ SESSION COMPLETE</div>
                        <div class="block-subtitle">Great work!</div>
                        <div class="block-progress-dots">${dots}</div>
                    </div>
                    <button class="block-nav-btn" disabled>Next ▶</button>
                </div>

                <div class="summary-block">
                    <div class="summary-icon">🏆</div>
                    <div class="summary-title">Session ${currentSessionType} Complete!</div>
                    
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <div class="summary-stat-value">${totalRepsSession}</div>
                            <div class="summary-stat-label">Reps Completed</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value">${elapsed}</div>
                            <div class="summary-stat-label">Minutes</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-stat-value">${completedExercises.length}</div>
                            <div class="summary-stat-label">Exercises</div>
                        </div>
                    </div>

                    <div class="summary-exercises">
                        ${completedExercises.map(ex => `
                            <div class="summary-exercise-item ${ex.sets === ex.totalSets ? 'completed' : ''}">
                                <span>${ex.name}</span>
                                <span>${ex.sets}/${ex.totalSets} sets @ ${ex.weight}</span>
                            </div>
                        `).join('')}
                    </div>

                    <div class="notes-section" style="margin-top: 20px;">
                        <label class="notes-label" for="workoutNotes">Session Notes (optional)</label>
                        <textarea 
                            class="notes-input" 
                            id="workoutNotes" 
                            placeholder="How did the session feel? Any adjustments needed?"
                        ></textarea>
                    </div>

                    <button class="complete-block-btn" onclick="attemptCompleteSession()">
                        ✓ Save & Complete Session
                    </button>
                </div>
            `;
        }

        function playVideo(wrapper, videoId) {
            wrapper.innerHTML = `
                <iframe 
                    src="https://www.youtube.com/embed/${videoId}?autoplay=1" 
                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                    allowfullscreen>
                </iframe>
            `;
        }

        function toggleSet(exIndex, setIndex) {
            const block = workoutBlocks[currentBlockIndex];
            const exercise = block.exercises[exIndex];
            
            // If this is the first checkbox in the block, start timing
            const wasBlockEmpty = block.exercises.every(ex => ex.completed.every(c => !c));
            
            exercise.completed[setIndex] = !exercise.completed[setIndex];
            
            // Start block timer if first checkbox
            if (wasBlockEmpty && exercise.completed[setIndex]) {
                blockStartTime = Date.now();
            }
            
            // Check if block is now complete
            const isBlockComplete = block.exercises.every(ex => ex.completed.every(c => c));
            
            if (isBlockComplete && blockStartTime) {
                const blockDuration = Date.now() - blockStartTime;
                
                // If completed too fast (under 60 seconds) and it's not warmup, show sloth reminder
                if (blockDuration < MIN_BLOCK_DURATION && block.type !== 'warmup' && !slothPauseActive) {
                    showBlockSlothModal();
                }
            }
            
            renderCurrentBlock();
            saveSessionToStorage();
        }
        
        function showBlockSlothModal() {
            // Just show the popup as a reminder, don't block
            const modal = document.getElementById('slothModal');
            modal.classList.add('active');
            
            // Auto-dismiss after 4 seconds
            setTimeout(() => {
                modal.classList.remove('active');
                slothPauseActive = false;
                blockStartTime = null;
            }, 4000);
            
            // Still render the block
            renderCurrentBlock();
        }

        // Track which exercises have been confirmed for increase (per session)
        const confirmedIncreases = new Set();
        
        function adjustBlockWeight(exIndex, delta) {
            const block = workoutBlocks[currentBlockIndex];
            const exercise = block.exercises[exIndex];
            const currentWeight = exercise.weight || 0;
            const newWeight = Math.max(0, currentWeight + delta);
            const lastWeight = exercise.lastTime?.weight || 0;
            
            // Check if increasing above last time's weight (and not already confirmed)
            const exerciseKey = `${currentBlockIndex}-${exIndex}`;
            if (delta > 0 && newWeight > lastWeight && lastWeight > 0 && !confirmedIncreases.has(exerciseKey)) {
                showWeightIncreaseModal(exIndex, lastWeight, newWeight, exerciseKey);
                return;
            }
            
            // Apply weight change and re-render block
            exercise.weight = newWeight;
            renderCurrentBlock();
            saveSessionToStorage();
        }
        
        function showWeightIncreaseModal(exIndex, lastWeight, newWeight, exerciseKey) {
            const modal = document.getElementById('weightIncreaseModal');
            document.getElementById('weightIncreaseFrom').textContent = lastWeight;
            document.getElementById('weightIncreaseTo').textContent = newWeight;
            document.getElementById('weightStayAt').textContent = lastWeight;
            
            // Store for confirm/cancel
            modal.dataset.exIndex = exIndex;
            modal.dataset.newWeight = newWeight;
            modal.dataset.lastWeight = lastWeight;
            modal.dataset.exerciseKey = exerciseKey;
            
            // Reset checkboxes
            document.querySelectorAll('.weight-check').forEach(cb => cb.checked = false);
            document.getElementById('confirmWeightBtn').disabled = true;
            document.getElementById('confirmWeightBtn').style.opacity = '0.5';
            
            modal.classList.add('active');
        }
        
        function updateWeightConfirmBtn() {
            const allChecked = document.querySelectorAll('.weight-check:checked').length === 3;
            const btn = document.getElementById('confirmWeightBtn');
            btn.disabled = !allChecked;
            btn.style.opacity = allChecked ? '1' : '0.5';
        }
        
        function confirmWeightIncrease() {
            const modal = document.getElementById('weightIncreaseModal');
            const exIndex = parseInt(modal.dataset.exIndex);
            const newWeight = parseFloat(modal.dataset.newWeight);
            const exerciseKey = modal.dataset.exerciseKey;
            
            // Mark as confirmed so they can adjust freely now
            confirmedIncreases.add(exerciseKey);
            
            // Apply weight change
            const block = workoutBlocks[currentBlockIndex];
            const exercise = block.exercises[exIndex];
            exercise.weight = newWeight;
            
            modal.classList.remove('active');
            renderCurrentBlock();
            saveSessionToStorage();
        }
        
        function cancelWeightIncrease() {
            document.getElementById('weightIncreaseModal').classList.remove('active');
        }
        
        // ============================================
        // PROGRESSION PROMPT HANDLERS
        // ============================================
        let currentProgressionPrompt = null;
        let progressionCallback = null;
        
        function showProgressionPrompt(promptData, onAccept, onDecline) {
            currentProgressionPrompt = promptData;
            progressionCallback = { onAccept, onDecline };
            
            const modal = document.getElementById('progressionModal');
            const isReps = promptData.type === 'reps';
            
            // Set the message
            document.getElementById('progressionMessage').innerHTML = `
                You've crushed <strong>${promptData.exerciseName}</strong> at 
                <strong>${promptData.currentValue}${isReps ? ' reps' : 'kg'}</strong> 
                for ${promptData.consecutiveSessions} session${promptData.consecutiveSessions > 1 ? 's' : ''} in a row!
            `;
            
            // Set the from/to values
            document.getElementById('progressionFrom').textContent = promptData.currentValue + (isReps ? ' reps' : 'kg');
            document.getElementById('progressionTo').textContent = promptData.newValue + (isReps ? ' reps' : 'kg');
            
            // Set the reason
            const reasonText = promptData.sessionsRequired > 1 
                ? `+${promptData.increment}${isReps ? ' rep' : 'kg'} after ${promptData.sessionsRequired} successful sessions`
                : `+${promptData.increment}${isReps ? ' rep' : 'kg'} — small steps, big gains!`;
            document.getElementById('progressionReason').textContent = reasonText;
            
            // Reset checkboxes
            document.querySelectorAll('.progression-check').forEach(cb => cb.checked = false);
            document.getElementById('confirmProgressionBtn').disabled = true;
            document.getElementById('confirmProgressionBtn').style.opacity = '0.5';
            
            modal.style.display = 'flex';
            setTimeout(() => modal.classList.add('active'), 10);
        }
        
        function updateProgressionConfirmBtn() {
            const checkboxes = document.querySelectorAll('.progression-check');
            const allChecked = Array.from(checkboxes).every(cb => cb.checked);
            const btn = document.getElementById('confirmProgressionBtn');
            btn.disabled = !allChecked;
            btn.style.opacity = allChecked ? '1' : '0.5';
        }
        
        function acceptProgression() {
            const modal = document.getElementById('progressionModal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
            
            if (progressionCallback && progressionCallback.onAccept) {
                progressionCallback.onAccept(currentProgressionPrompt.newValue);
            }
            currentProgressionPrompt = null;
            progressionCallback = null;
        }
        
        function declineProgression() {
            const modal = document.getElementById('progressionModal');
            modal.classList.remove('active');
            setTimeout(() => modal.style.display = 'none', 300);
            
            if (progressionCallback && progressionCallback.onDecline) {
                progressionCallback.onDecline(currentProgressionPrompt.currentValue);
            }
            currentProgressionPrompt = null;
            progressionCallback = null;
        }
        
        // Inline progression prompt handlers (for the banner in the workout block)
        function triggerProgressionPrompt(exIndex) {
            const block = workoutBlocks[currentBlockIndex];
            const exercise = block.exercises[exIndex];
            
            if (!exercise.progressionEligible) return;
            
            showProgressionPrompt(
                exercise.progressionEligible,
                (newValue) => {
                    // Accept: update weight/reps and re-render
                    if (exercise.progressionEligible.type === 'reps') {
                        exercise.reps = newValue;
                    } else {
                        exercise.weight = newValue;
                    }
                    exercise.progressionAccepted = true;
                    exercise.progressionEligible = null; // Clear so banner doesn't show again
                    renderCurrentBlock();
                    saveSessionToStorage();
                    showToast('Let\'s go! Weight updated 💪', 'success');
                },
                (currentValue) => {
                    // Decline: mark as declined so banner hides
                    exercise.progressionDeclined = true;
                    renderCurrentBlock();
                    saveSessionToStorage();
                }
            );
        }
        
        function declineProgressionInline(exIndex) {
            const block = workoutBlocks[currentBlockIndex];
            const exercise = block.exercises[exIndex];
            exercise.progressionDeclined = true;
            renderCurrentBlock();
            saveSessionToStorage();
        }

        function prevBlock() {
            if (currentBlockIndex > 0) {
                currentBlockIndex--;
                renderCurrentBlock();
                saveSessionToStorage();
            }
        }

        function nextBlock() {
            if (currentBlockIndex < workoutBlocks.length - 1) {
                currentBlockIndex++;
                renderCurrentBlock();
                saveSessionToStorage();
            }
        }

        function goToBlock(index) {
            currentBlockIndex = index;
            renderCurrentBlock();
            saveSessionToStorage();
        }

        function isBlockComplete(blockIndex) {
            const block = workoutBlocks[blockIndex];
            if (!block.exercises) return blockIndex < currentBlockIndex;
            return block.exercises.every(ex => ex.completed.every(c => c));
        }

        // ============================================
        // COMPLETE WORKOUT WITH SLOTH CHECK
        // ============================================
        function attemptCompleteSession() {
            if (!sessionStartTime) {
                showToast('Please start a session first', 'error');
                return;
            }

            const elapsed = Date.now() - sessionStartTime;
            const remaining = MIN_SESSION_DURATION - elapsed;

            if (remaining > 0 && !slothShown) {
                // Show sloth popup as a reminder (but don't block)
                showSlothModal(remaining);
                slothShown = true;
            }

            // Show RPE modal before completing
            showRpeModal();
        }

        function showRpeModal() {
            document.getElementById('rpeModal').classList.add('active');
        }

        function selectRpe(value) {
            // Update selection UI
            document.querySelectorAll('.rpe-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            document.querySelector(`.rpe-option[data-rpe="${value}"]`).classList.add('selected');
            
            // Enable confirm button
            document.getElementById('rpeConfirmBtn').disabled = false;
            document.getElementById('rpeConfirmBtn').style.opacity = '1';
            
            // Store selected RPE
            document.getElementById('rpeModal').dataset.selectedRpe = value;
        }

        function confirmRpeAndComplete() {
            const rpe = document.getElementById('rpeModal').dataset.selectedRpe;
            document.getElementById('rpeModal').classList.remove('active');
            completeWorkout(rpe);
        }

        function skipRpe() {
            document.getElementById('rpeModal').classList.remove('active');
            completeWorkout(null);
        }

        function showSlothModal(remainingMs) {
            const modal = document.getElementById('slothModal');
            modal.classList.add('active');
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                modal.classList.remove('active');
            }, 5000);
        }

        function dismissSlothModal() {
            // Close the popup
            document.getElementById('slothModal').classList.remove('active');
        }

        async function completeWorkout(sessionRpe) {
            // Close sloth modal if open
            document.getElementById('slothModal').classList.remove('active');

            // Calculate totals from blocks
            let totalRepsSession = 0;
            const exercisesCompleted = [];
            
            workoutBlocks.forEach((block, blockIdx) => {
                if (block.exercises) {
                    block.exercises.forEach((ex, exIdx) => {
                        const completedSets = ex.completed.filter(c => c).length;
                        const repsPerSet = ex.reps || 1;
                        totalRepsSession += completedSets * repsPerSet;
                        
                        if (completedSets > 0) {
                            // Check if this is a technique practice exercise - grab recorded sets/reps
                            let loggedSets = completedSets;
                            let loggedReps = repsPerSet;
                            let loggedWeight = ex.weight || 'bodyweight';
                            
                            if (ex.linkToAssessment) {
                                const techSetsInput = document.getElementById(`techSets-${exIdx}`);
                                const techRepsInput = document.getElementById(`techReps-${exIdx}`);
                                if (techSetsInput) loggedSets = parseInt(techSetsInput.value) || 2;
                                if (techRepsInput) loggedReps = parseInt(techRepsInput.value) || 8;
                                loggedWeight = 'bodyweight';
                            }
                            
                            // For rep-based patterns (Pull), store reps as weight field  
                            const patternDef = ex.patternName ? patterns.find(p => p.name === ex.patternName) : null;
                            if (patternDef && patternDef.testType === 'reps') {
                                loggedWeight = loggedReps + ' reps';
                            }
                            
                            exercisesCompleted.push({
                                name: ex.name,
                                pattern: ex.patternName || 'Core',
                                sets: loggedSets,
                                reps: loggedReps,
                                weight: loggedWeight,
                                type: ex.linkToAssessment ? 'technique' : 'workout'
                            });
                        }
                    });
                }
            });

            const duration = sessionStartTime ? Math.round((Date.now() - sessionStartTime) / 60000) : 0;
            const notes = document.getElementById('workoutNotes')?.value || '';
            
            try {
                showToast('Saving session...', 'success');

                // Save to Google Sheets
                const response = await fetch(APPS_SCRIPT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        action: 'saveWorkout',
                        email: currentUser.athleteId,
                        sessionType: currentSessionType,
                        sessionNumber: Math.floor(currentSessionNumber / 2) + 1,
                        exercisesCompleted: JSON.stringify(exercisesCompleted),
                        notes: notes,
                        duration: duration,
                        totalReps: totalRepsSession,
                        rpe: sessionRpe || null
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Stop timer
                    if (sessionTimer) {
                        clearInterval(sessionTimer);
                        sessionTimer = null;
                    }
                    
                    showToast(`🎉 Session ${currentSessionType} complete! ${totalRepsSession} reps logged.`, 'success');
                    
                    // Update stats display
                    const currentTotal = parseInt(document.getElementById('totalSessions').textContent) || 0;
                    const currentReps = parseInt(document.getElementById('totalReps').textContent) || 0;
                    document.getElementById('totalSessions').textContent = currentTotal + 1;
                    document.getElementById('totalReps').textContent = currentReps + totalRepsSession;
                    
                    // Clear cache to get fresh data next time
                    athleteDataCache = null;
                    
                    // Clear saved session - workout is done
                    clearSessionStorage();
                    
                    // Show Session Complete state instead of resetting
                    sessionStartTime = null;
                    document.getElementById('sessionTimer').style.display = 'none';
                    showSessionCompleteState(currentSessionType, totalRepsSession, duration, exercisesCompleted);
                    
                } else {
                    throw new Error(result.error || 'Save failed');
                }
                
            } catch (error) {
                console.error('Error completing workout:', error);
                showToast('Error saving session. Please try again.', 'error');
            }
        }

        // ============================================
        // WORKOUT HISTORY
        // ============================================
        
        function showSessionCompleteState(sessionType, totalReps, duration, exercises) {
            const container = document.getElementById('workoutBlockContainer');
            container.style.display = 'block';
            
            container.innerHTML = `
                <div class="session-complete-card" style="
                    background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.05));
                    border: 2px solid rgba(34, 197, 94, 0.3);
                    border-radius: 20px;
                    padding: 40px;
                    text-align: center;
                ">
                    <div style="font-size: 4rem; margin-bottom: 20px;">🎉</div>
                    <h2 style="color: #22c55e; font-size: 1.8rem; margin-bottom: 10px;">Session ${sessionType} Complete!</h2>
                    <p style="color: #444; font-size: 1.1rem; margin-bottom: 30px;">Great work today</p>
                    
                    <div style="display: flex; justify-content: center; gap: 40px; margin-bottom: 30px;">
                        <div>
                            <div style="font-size: 2.5rem; font-weight: 700; color: #22c55e;">${totalReps}</div>
                            <div style="color: #555; font-size: 0.9rem;">Reps</div>
                        </div>
                        <div>
                            <div style="font-size: 2.5rem; font-weight: 700; color: #22c55e;">${duration}</div>
                            <div style="color: #555; font-size: 0.9rem;">Minutes</div>
                        </div>
                        <div>
                            <div style="font-size: 2.5rem; font-weight: 700; color: #22c55e;">${exercises.length}</div>
                            <div style="color: #555; font-size: 0.9rem;">Exercises</div>
                        </div>
                    </div>
                    
                    <div style="
                        background: rgba(0,0,0,0.2);
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 30px;
                        text-align: left;
                    ">
                        <div style="color: #444; font-size: 0.9rem; margin-bottom: 15px; font-weight: 600;">📋 Exercises Logged:</div>
                        ${exercises.map(ex => `
                            <div style="display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <span style="color: #444;">${ex.name}</span>
                                <span style="color: #22c55e;">${ex.sets} sets @ ${typeof ex.weight === 'string' && (ex.weight.includes('reps') || ex.weight === 'bodyweight') ? ex.weight : ex.weight + 'kg'}</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div style="
                        background: rgba(135, 75, 70, 0.1);
                        border: 1px solid rgba(135, 75, 70, 0.3);
                        border-radius: 12px;
                        padding: 20px;
                        margin-bottom: 25px;
                    ">
                        <div style="color: #D4AF37; font-size: 0.95rem;">
                            <strong>📅 Next session:</strong> Session ${sessionType === 'A' ? 'B' : 'A'} will be unlocked in your next class
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="repeatSession()" style="
                            padding: 14px 28px;
                            background: #f5f0f1;
                            border: 1px solid rgba(255,255,255,0.2);
                            color: #231F20;
                            border-radius: 10px;
                            font-size: 0.95rem;
                            cursor: pointer;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(255,255,255,0.15)'" onmouseout="this.style.background='rgba(255,255,255,0.1)'">
                            🔄 Repeat Session ${sessionType}
                        </button>
                        <button onclick="showWorkoutHistory()" style="
                            padding: 14px 28px;
                            background: rgba(135, 75, 70, 0.2);
                            border: 1px solid rgba(135, 75, 70, 0.3);
                            color: #D4AF37;
                            border-radius: 10px;
                            font-size: 0.95rem;
                            cursor: pointer;
                            transition: all 0.2s;
                        " onmouseover="this.style.background='rgba(135, 75, 70, 0.3)'" onmouseout="this.style.background='rgba(135, 75, 70, 0.2)'">
                            📊 View History
                        </button>
                    </div>
                </div>
            `;
        }
        
        function repeatSession() {
            // Stop any running timer
            if (sessionTimer) {
                clearInterval(sessionTimer);
                sessionTimer = null;
            }
            sessionStartTime = null;
            
            // Clear saved session
            clearSessionStorage();
            
            // Reset UI - restore the currentBlock div inside container
            const container = document.getElementById('workoutBlockContainer');
            container.style.display = 'none';
            container.innerHTML = '<div class="workout-block" id="currentBlock"></div>';
            document.getElementById('sessionTimer').style.display = 'none';
            document.getElementById('completeSessionBtn').style.display = 'none';
            document.getElementById('sessionNotStarted').style.display = 'block';
            
            // Rebuild fresh workout blocks
            buildWorkoutBlocks(currentStrength, currentSessionType, null);
        }

        async function showWorkoutHistory() {
            document.getElementById('historyModal').classList.add('active');
            document.getElementById('historyList').innerHTML = '<div class="no-history">Loading history...</div>';
            
            try {
                console.log('📋 Fetching history for:', currentUser.athleteId);
                const history = await fetchWorkoutHistory(currentUser.athleteId, 20);
                console.log('📋 History response:', history);
                
                if (!history || history.length === 0) {
                    document.getElementById('historyList').innerHTML = `
                        <div class="no-history">
                            <div style="font-size: 2rem; margin-bottom: 10px;">📭</div>
                            No workout history yet.<br>Complete a session and it will show up here!
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                history.forEach(item => {
                    // Parse exercises if they're a string
                    let exerciseList = '';
                    if (item.exercises) {
                        let exercises = item.exercises;
                        if (typeof exercises === 'string') {
                            try { exercises = JSON.parse(exercises); } catch(e) { exercises = []; }
                        }
                        if (Array.isArray(exercises) && exercises.length > 0) {
                            exerciseList = `
                                <div style="margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee;">
                                    ${exercises.map(ex => `
                                        <div style="display: flex; justify-content: space-between; font-size: 0.8rem; padding: 2px 0; color: #666;">
                                            <span>${ex.name || 'Unknown'}</span>
                                            <span style="color: #874B46; font-weight: 600;">${ex.sets || '?'}×${ex.reps || '?'} ${ex.weight && ex.weight !== 'bodyweight' ? '@ ' + ex.weight + (String(ex.weight).includes('reps') ? '' : 'kg') : ''}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            `;
                        }
                    }
                    
                    html += `
                        <div class="history-item">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
                                <div class="history-date">${item.date || 'Unknown date'}</div>
                                ${item.rpe ? `<div style="background: rgba(135,75,70,0.1); color: #874B46; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; font-weight: 600;">RPE ${item.rpe}/10</div>` : ''}
                            </div>
                            <div class="history-session">Session ${item.number || '?'}${item.type || ''}</div>
                            <div style="display: flex; gap: 15px; margin-top: 4px;">
                                <span style="font-size: 0.85rem; color: #888;">⏱ ${item.duration || '?'} min</span>
                                ${item.totalReps ? `<span style="font-size: 0.85rem; color: #888;">💪 ${item.totalReps} reps</span>` : ''}
                            </div>
                            ${item.notes ? `<div class="history-notes" style="margin-top: 6px; font-style: italic; color: #999; font-size: 0.85rem;">"${item.notes}"</div>` : ''}
                            ${exerciseList}
                        </div>
                    `;
                });
                
                document.getElementById('historyList').innerHTML = html;
            } catch (error) {
                console.error('📋 History error:', error);
                document.getElementById('historyList').innerHTML = `
                    <div class="no-history">
                        <div style="font-size: 2rem; margin-bottom: 10px;">⚠️</div>
                        Error loading history<br>
                        <span style="font-size: 0.8rem; color: #999;">${error.message}</span>
                    </div>
                `;
            }
        }

        function closeHistoryModal() {
            document.getElementById('historyModal').classList.remove('active');
        }

        // Close modal on outside click
        document.getElementById('historyModal').addEventListener('click', function(e) {
            if (e.target === this) closeHistoryModal();
        });

        // ============================================
        // TEST CONNECTION
        // ============================================
        async function testConnection() {
            const btn = document.querySelector('.test-connection-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '⏳ Testing...';
            btn.disabled = true;
            
            try {
                const url = `${APPS_SCRIPT_URL}?action=getAthleteData&email=${encodeURIComponent(currentUser.email)}`;
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.success) {
                    btn.innerHTML = '✅ Connected!';
                    btn.style.color = '#22c55e';
                    showToast('Connection successful!', 'success');
                } else {
                    throw new Error(data.error);
                }
            } catch (error) {
                btn.innerHTML = '❌ Failed';
                btn.style.color = '#ef4444';
                showToast('Connection failed: ' + error.message, 'error');
            }
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.color = '';
                btn.disabled = false;
            }, 3000);
        }

        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type} active`;
            
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }
    </script>
</body>
</html>
